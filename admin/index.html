<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flatwater Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0a15;
      color: #fff;
      min-height: 100vh;
    }
    
    /* Login Screen */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .login-box {
      width: 100%;
      max-width: 400px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(139,92,246,0.2);
      border-radius: 24px;
      padding: 40px 30px;
    }
    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .login-header h1 {
      font-size: 28px;
      color: #a78bfa;
      margin-bottom: 8px;
    }
    .login-header p {
      color: rgba(255,255,255,0.5);
      font-size: 14px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: rgba(255,255,255,0.7);
      font-size: 14px;
    }
    .form-group input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(139,92,246,0.2);
      border-radius: 12px;
      color: #fff;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
    }
    .form-group input:focus {
      border-color: #8b5cf6;
    }
    .btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn:hover {
      opacity: 0.9;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .error-message {
      color: #f43f5e;
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
      padding: 10px;
      background: rgba(244,63,94,0.1);
      border-radius: 8px;
      display: none;
    }
    .error-message.show {
      display: block;
    }
    
    /* Admin Panel */
    .admin-container {
      display: none;
      min-height: 100vh;
    }
    .admin-container.active {
      display: block;
    }
    .admin-header {
      background: rgba(10,10,20,0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .admin-header h1 {
      font-size: 20px;
      color: #a78bfa;
    }
    .admin-header .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .admin-header .user-info span {
      color: rgba(255,255,255,0.7);
      font-size: 14px;
    }
    .logout-btn {
      padding: 8px 16px;
      background: rgba(244,63,94,0.2);
      border: 1px solid rgba(244,63,94,0.3);
      border-radius: 8px;
      color: #f43f5e;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }
    .logout-btn:hover {
      background: rgba(244,63,94,0.3);
    }
    
    .admin-content {
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 16px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 10px 20px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: rgba(255,255,255,0.6);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .tab:hover {
      background: rgba(255,255,255,0.08);
    }
    .tab.active {
      background: rgba(139,92,246,0.2);
      border-color: rgba(139,92,246,0.4);
      color: #a78bfa;
    }
    
    .panel {
      display: none;
    }
    .panel.active {
      display: block;
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .panel-header h2 {
      font-size: 18px;
      color: #fff;
    }
    .add-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    
    .search-box {
      margin-bottom: 16px;
    }
    .search-input {
      width: 100%;
      max-width: 400px;
      padding: 12px 16px 12px 42px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(139,92,246,0.2);
      border-radius: 10px;
      color: #fff;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%238b5cf6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 12px center;
      background-size: 20px;
    }
    .search-input:focus {
      border-color: #8b5cf6;
    }
    .search-input::placeholder {
      color: rgba(255,255,255,0.4);
    }
    .table-container {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    th {
      background: rgba(139,92,246,0.1);
      color: rgba(255,255,255,0.8);
      font-size: 12px;
      text-transform: uppercase;
      font-weight: 600;
    }
    td {
      color: rgba(255,255,255,0.7);
      font-size: 14px;
    }
    tr:hover {
      background: rgba(255,255,255,0.02);
    }
    .actions {
      display: flex;
      gap: 8px;
    }
    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }
    .edit-btn {
      background: rgba(139,92,246,0.2);
      color: #a78bfa;
    }
    .delete-btn {
      background: rgba(244,63,94,0.2);
      color: #f43f5e;
    }
    
    /* Public ID styling */
    .public-id {
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 11px;
      background: rgba(139,92,246,0.15);
      color: #a78bfa;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
      letter-spacing: 0.5px;
    }
    
    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-admin {
      background: rgba(139,92,246,0.2);
      color: #a78bfa;
    }
    .badge-user {
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.6);
    }
    
    /* User Details Tabs */
    .detail-tab {
      transition: all 0.2s;
    }
    .detail-tab:hover {
      opacity: 0.8;
    }
    .detail-tab.active {
      background: linear-gradient(135deg,#8b5cf6,#a78bfa) !important;
      color: #fff !important;
    }
    .detail-panel {
      display: none;
    }
    .detail-panel.active {
      display: block;
    }
    .status-active {
      background: rgba(34,197,94,0.2);
      color: #22c55e;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }
    .status-deleted {
      background: rgba(239,68,68,0.2);
      color: #ef4444;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }
    .comment-content {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .type-badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }
    .type-trick {
      background: rgba(59,130,246,0.2);
      color: #3b82f6;
    }
    .type-achievement {
      background: rgba(245,158,11,0.2);
      color: #f59e0b;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: #0a0a15;
      border: 1px solid rgba(139,92,246,0.2);
      border-radius: 20px;
      padding: 30px;
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .emoji-picker {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .emoji-btn {
      width: 44px;
      height: 44px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      font-size: 22px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .emoji-btn:hover {
      background: rgba(139,92,246,0.3);
      border-color: rgba(139,92,246,0.5);
    }
    .emoji-btn.selected {
      background: rgba(139,92,246,0.4);
      border-color: #8b5cf6;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .modal-header h3 {
      font-size: 20px;
      color: #fff;
    }
    .close-btn {
      background: none;
      border: none;
      color: rgba(255,255,255,0.5);
      font-size: 24px;
      cursor: pointer;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 24px;
    }
    .modal-actions .btn {
      flex: 1;
    }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .avatar-small {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }
    .avatar-small img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.5);
    }
    
    /* Panel Selection Screen */
    .panel-selection {
      display: none;
      min-height: 100vh;
      background: #0a0a15;
      padding: 40px 20px;
    }
    .panel-selection.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .panel-selection h1 {
      font-size: 28px;
      color: #fff;
      margin-bottom: 12px;
      text-align: center;
    }
    .panel-selection p {
      color: rgba(255,255,255,0.5);
      margin-bottom: 40px;
      text-align: center;
    }
    .panel-cards {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 900px;
    }
    .panel-card {
      flex: 1;
      min-width: 200px;
      max-width: 260px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 32px 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .panel-card:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(139,92,246,0.4);
      transform: translateY(-4px);
    }
    .panel-card.admin-card:hover {
      border-color: rgba(139,92,246,0.6);
    }
    .panel-card.sales-card:hover {
      border-color: rgba(34,197,94,0.6);
    }
    .panel-card.howto-card:hover {
      border-color: rgba(59,130,246,0.6);
    }
    .panel-card-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 28px;
    }
    .admin-card .panel-card-icon {
      background: linear-gradient(135deg, rgba(139,92,246,0.3), rgba(99,102,241,0.3));
    }
    .sales-card .panel-card-icon {
      background: linear-gradient(135deg, rgba(34,197,94,0.3), rgba(22,163,74,0.3));
    }
    .howto-card .panel-card-icon {
      background: linear-gradient(135deg, rgba(59,130,246,0.3), rgba(37,99,235,0.3));
    }
    .panel-card h3 {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }
    .panel-card p {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      margin: 0;
    }
    .panel-selection-logout {
      margin-top: 40px;
      padding: 12px 24px;
      background: rgba(244,63,94,0.1);
      border: 1px solid rgba(244,63,94,0.3);
      border-radius: 10px;
      color: #f43f5e;
      cursor: pointer;
      font-size: 14px;
    }
    .panel-selection-logout:hover {
      background: rgba(244,63,94,0.2);
    }
    
    /* User Widget in Header */
    .user-widget {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 50px;
      padding: 6px 14px 6px 6px;
    }
    .user-widget-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #a78bfa);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }
    .user-widget-name {
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    select, textarea {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(139,92,246,0.2);
      border-radius: 12px;
      color: #fff;
      font-size: 15px;
      outline: none;
      font-family: inherit;
    }
    select option {
      background: #0a0a15;
    }
    textarea {
      resize: vertical;
    }
    
    /* Rich text toolbar */
    .rich-toolbar {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .rich-toolbar button {
      padding: 6px 12px;
      background: rgba(139,92,246,0.15);
      border: 1px solid rgba(139,92,246,0.3);
      border-radius: 8px;
      color: #c4b5fd;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }
    .rich-toolbar button:hover {
      background: rgba(139,92,246,0.3);
      color: #fff;
    }
    .rich-toolbar .hint {
      margin-left: auto;
      font-size: 11px;
      color: rgba(255,255,255,0.3);
      align-self: center;
    }
    
    /* Email template cards hover */
    .email-template-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-container" id="loginScreen">
    <div class="login-box">
      <div class="login-header">
        <h1>üîß Admin Panel</h1>
        <p>WakeWay Management</p>
      </div>
      
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="admin@example.com">
      </div>
      
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      
      <button class="btn" id="loginBtn" onclick="handleLogin()">Login</button>
      
      <div class="error-message" id="loginError"></div>
    </div>
  </div>

  <!-- Panel Selection Screen -->
  <div class="panel-selection" id="panelSelection">
    <h1>üëã Welcome back!</h1>
    <p>Choose where you want to go</p>
    
    <div class="panel-cards">
      <div class="panel-card admin-card" onclick="goToAdminPanel()">
        <div class="panel-card-icon">üîß</div>
        <h3>Admin Panel</h3>
        <p>Manage users, tricks, events, articles and products</p>
      </div>
      
      <div class="panel-card sales-card" onclick="goToSalesPanel()">
        <div class="panel-card-icon">üìä</div>
        <h3>Sales Panel</h3>
        <p>View sales reports, statistics and revenue data</p>
      </div>
      
      <div class="panel-card howto-card" onclick="goToHowtoPanel()">
        <div class="panel-card-icon">üìã</div>
        <h3>How Do Things?</h3>
        <p>Staff guides, checklists and important contacts</p>
      </div>
      
      <div class="panel-card" onclick="goToTestV2()" style="border-color: rgba(239,68,68,0.3);">
        <div class="panel-card-icon" style="background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(220,38,38,0.3));">üß™</div>
        <h3>Test v2</h3>
        <p>Automated diagnostics for the Vite+React app</p>
      </div>
    </div>
    
    <button class="panel-selection-logout" onclick="handleLogout()">Logout</button>
  </div>

  <!-- Admin Panel -->
  <div class="admin-container" id="adminPanel">
    <header class="admin-header">
      <div style="display: flex; align-items: center; gap: 12px;">
        <button onclick="goBackToSelection()" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px 12px; color: #fff; cursor: pointer; font-size: 13px;">‚Üê Back</button>
        <h1>üîß WakeWay Admin</h1>
      </div>
      <div class="user-info">
        <div class="user-widget">
          <div class="user-widget-avatar" id="adminAvatar"></div>
          <span class="user-widget-name" id="adminUsername"></span>
        </div>
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
      </div>
    </header>
    
    <div class="admin-content">
      <div class="tabs">
        <div class="tab" data-tab="pending" onclick="switchTab('pending')">üîî Pending</div>
        <div class="tab active" data-tab="users" onclick="switchTab('users')">Users</div>
        <div class="tab" data-tab="tricks" onclick="switchTab('tricks')">Tricks</div>
        <div class="tab" data-tab="events" onclick="switchTab('events')">Events</div>
        <div class="tab" data-tab="articles" onclick="switchTab('articles')">Articles</div>
        <div class="tab" data-tab="news" onclick="switchTab('news')">News</div>
        <div class="tab" data-tab="products" onclick="switchTab('products')">üõí Products</div>
        <div class="tab" data-tab="achievements" onclick="switchTab('achievements')">üèÜ Achievements</div>
        <div class="tab" data-tab="comments" onclick="switchTab('comments')">üí¨ Comments</div>
        <div class="tab" data-tab="emails" onclick="switchTab('emails')">üìß Emails</div>
        <div class="tab" data-tab="userDetails" id="userDetailsTab" style="display:none;" onclick="switchTab('userDetails')">üë§ User Details</div>
      </div>
      
      <!-- Pending Approvals Panel -->
      <div class="panel" id="pendingPanel">
        <div class="panel-header">
          <h2>‚è≥ Pending Approvals</h2>
          <button class="add-btn" onclick="loadPendingUsers()">‚Üª Refresh</button>
        </div>
        <div id="pendingCount" style="margin-bottom: 16px; padding: 12px; background: rgba(139,92,246,0.1); border-radius: 8px; color: #a78bfa;"></div>
        <div class="search-box">
          <input type="text" class="search-input" id="pendingSearch" placeholder="Search pending users..." oninput="filterTable('pendingUsersTable', this.value)">
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Registered</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="pendingUsersTable">
              <tr><td colspan="4" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Users Panel -->
      <div class="panel active" id="usersPanel">
        <div class="panel-header">
          <h2>Users</h2>
          <button class="add-btn" onclick="openUserModal()">+ Add User</button>
        </div>
        <div class="search-box">
          <input type="text" class="search-input" id="usersSearch" placeholder="Search users by name, email..." oninput="filterTable('usersTable', this.value)">
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Avatar</th>
                <th>Username</th>
                <th>Email</th>
                <th>Birthdate</th>
                <th>Role</th>
                <th>Last Login</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTable">
              <tr><td colspan="10" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Tricks Panel -->
      <div class="panel" id="tricksPanel">
        <div class="panel-header">
          <h2>Tricks</h2>
          <button class="add-btn" onclick="openTrickModal()">+ Add Trick</button>
        </div>
        <div class="search-box">
          <input type="text" class="search-input" id="tricksSearch" placeholder="Search tricks by name, category..." oninput="filterTable('tricksTable', this.value)">
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Category</th>
                <th>Difficulty</th>
                <th>Pos</th>
                <th>Description</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tricksTable">
              <tr><td colspan="5" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Events Panel -->
      <div class="panel" id="eventsPanel">
        <div class="panel-header">
          <h2>Events</h2>
          <button class="add-btn" onclick="openEventModal()">+ Add Event</button>
        </div>
        <div class="search-box">
          <input type="text" class="search-input" id="eventsSearch" placeholder="Search events by name, location..." oninput="filterTable('eventsTable', this.value)">
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Date</th>
                <th>Time</th>
                <th>Location</th>
                <th>Spots</th>
                <th>Creator</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="eventsTable">
              <tr><td colspan="7" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- News Panel -->
      <div class="panel" id="newsPanel">
        <div class="panel-header">
          <h2>News</h2>
          <button class="add-btn" onclick="openNewsModal()">+ Add News</button>
        </div>
        <div class="search-box">
          <input type="text" class="search-input" id="newsSearch" placeholder="Search news by title, type..." oninput="filterTable('newsTable', this.value)">
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Type</th>
                <th>Message</th>
                <th>Reads</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="newsTable">
              <tr><td colspan="7" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Articles Panel -->
      <div class="panel" id="articlesPanel">
        <div class="panel-header">
          <h2>Articles (Learn Section)</h2>
          <button class="add-btn" onclick="openArticleModal()">+ Add Article</button>
        </div>
        <div class="search-box">
          <input type="text" class="search-input" id="articlesSearch" placeholder="Search articles by title, category..." oninput="filterTable('articlesTable', this.value)">
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Category</th>
                <th>Description</th>
                <th>Read Time</th>
                <th>Creator</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="articlesTable">
              <tr><td colspan="6" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Products Panel -->
      <div class="panel" id="productsPanel">
        <div class="panel-header">
          <h2>üõí Products (Shop)</h2>
          <button class="add-btn" onclick="openProductModal()">+ Add Product</button>
        </div>
        <div class="search-box">
          <input type="text" class="search-input" id="productsSearch" placeholder="Search products by name, category..." oninput="filterTable('productsTable', this.value)">
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Duration</th>
                <th>Active</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="productsTable">
              <tr><td colspan="7" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Achievements Panel -->
      <div class="panel" id="achievementsPanel">
        <div class="panel-header">
          <h2>üèÜ Achievements Analytics</h2>
          <button class="add-btn" onclick="loadAchievementsStats()">‚Üª Refresh</button>
        </div>
        <p style="margin-bottom: 20px; color: rgba(255,255,255,0.6); font-size: 14px;">Read-only view of achievement distribution across users. Manual achievements can be granted in User Details.</p>
        
        <!-- Automatic Achievements -->
        <h3 style="color: #a78bfa; margin-bottom: 16px; font-size: 16px;">üéØ Automatic Achievements (11)</h3>
        <div id="autoAchievementsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-bottom: 32px;">
          <div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">Loading...</div>
        </div>
        
        <!-- Manual Achievements -->
        <h3 style="color: #00CED1; margin-bottom: 16px; font-size: 16px;">‚≠ê Special Achievements (4)</h3>
        <div id="manualAchievementsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
          <div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">Loading...</div>
        </div>
      </div>

      <!-- Comments Panel -->
      <div class="panel" id="commentsPanel">
        <div class="panel-header">
          <h2>üí¨ All Comments</h2>
          <button class="add-btn" onclick="loadAllComments()">‚Üª Refresh</button>
        </div>
        
        <!-- Stats -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:12px;margin-bottom:20px;">
          <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:12px;padding:14px;text-align:center;">
            <div style="font-size:24px;font-weight:700;color:#3b82f6;" id="commentsTotal">0</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.5);">Total</div>
          </div>
          <div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:12px;padding:14px;text-align:center;">
            <div style="font-size:24px;font-weight:700;color:#22c55e;" id="commentsActive">0</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.5);">Active</div>
          </div>
          <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:12px;padding:14px;text-align:center;">
            <div style="font-size:24px;font-weight:700;color:#ef4444;" id="commentsDeleted">0</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.5);">Deleted</div>
          </div>
          <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:12px;padding:14px;text-align:center;">
            <div style="font-size:24px;font-weight:700;color:#3b82f6;" id="commentsTrick">0</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.5);">On Tricks</div>
          </div>
          <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);border-radius:12px;padding:14px;text-align:center;">
            <div style="font-size:24px;font-weight:700;color:#f59e0b;" id="commentsAchievement">0</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.5);">On Achievements</div>
          </div>
        </div>
        
        <!-- Filters -->
        <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
          <button class="comment-filter active" data-filter="all" onclick="filterComments('all')" style="padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:linear-gradient(135deg,#8b5cf6,#a78bfa);color:#fff;">All</button>
          <button class="comment-filter" data-filter="active" onclick="filterComments('active')" style="padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);">üü¢ Active</button>
          <button class="comment-filter" data-filter="deleted" onclick="filterComments('deleted')" style="padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);">üî¥ Deleted</button>
          <button class="comment-filter" data-filter="trick" onclick="filterComments('trick')" style="padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);">üéØ Tricks</button>
          <button class="comment-filter" data-filter="achievement" onclick="filterComments('achievement')" style="padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);">üèÜ Achievements</button>
        </div>
        
        <!-- Search -->
        <div class="search-box">
          <input type="text" class="search-input" id="commentsSearch" placeholder="Search by content, author, target..." oninput="searchComments(this.value)">
        </div>
        
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Status</th>
                <th>Date</th>
                <th>Author</th>
                <th>Content</th>
                <th>Type</th>
                <th>Target</th>
                <th>Owner</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="allCommentsTable">
              <tr><td colspan="8" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Emails Panel -->
      <div class="panel" id="emailsPanel">
        <div class="panel-header">
          <h2>üìß Email Templates</h2>
        </div>
        <p style="margin-bottom: 20px; color: rgba(255,255,255,0.6); font-size: 14px;">Preview email templates that are automatically sent by the system. Click on a template to see how it looks.</p>
        
        <!-- Email Templates Grid -->
        <div id="emailTemplatesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div class="email-template-card" onclick="showEmailPreview('registration_pending')" style="cursor:pointer;padding:20px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:16px;transition:all 0.2s;">
            <div style="font-size:32px;margin-bottom:12px;">‚è≥</div>
            <h4 style="color:#fff;font-size:15px;margin-bottom:4px;">Registration Pending</h4>
            <p style="font-size:12px;color:rgba(255,255,255,0.5);margin:0;">Sent when a new user registers</p>
          </div>
          <div class="email-template-card" onclick="showEmailPreview('account_approved')" style="cursor:pointer;padding:20px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:16px;transition:all 0.2s;">
            <div style="font-size:32px;margin-bottom:12px;">üéâ</div>
            <h4 style="color:#fff;font-size:15px;margin-bottom:4px;">Account Approved</h4>
            <p style="font-size:12px;color:rgba(255,255,255,0.5);margin:0;">Sent when admin approves a user</p>
          </div>
          <div class="email-template-card" onclick="showEmailPreview('purchase_confirmation')" style="cursor:pointer;padding:20px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:16px;transition:all 0.2s;">
            <div style="font-size:32px;margin-bottom:12px;">üõí</div>
            <h4 style="color:#fff;font-size:15px;margin-bottom:4px;">Purchase Confirmation</h4>
            <p style="font-size:12px;color:rgba(255,255,255,0.5);margin:0;">Sent after successful purchase</p>
          </div>
          <div class="email-template-card" onclick="showEmailPreview('new_news')" style="cursor:pointer;padding:20px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);border-radius:16px;transition:all 0.2s;">
            <div style="font-size:32px;margin-bottom:12px;">üì¢</div>
            <h4 style="color:#fff;font-size:15px;margin-bottom:4px;">New News/Announcement</h4>
            <p style="font-size:12px;color:rgba(255,255,255,0.5);margin:0;">Sent when new news is published</p>
          </div>
          <div class="email-template-card" onclick="showEmailPreview('achievement_unlocked')" style="cursor:pointer;padding:20px;background:rgba(234,179,8,0.1);border:1px solid rgba(234,179,8,0.2);border-radius:16px;transition:all 0.2s;">
            <div style="font-size:32px;margin-bottom:12px;">üèÜ</div>
            <h4 style="color:#fff;font-size:15px;margin-bottom:4px;">Achievement Unlocked</h4>
            <p style="font-size:12px;color:rgba(255,255,255,0.5);margin:0;">Sent when user earns achievement</p>
          </div>
          <div class="email-template-card" onclick="showEmailPreview('password_reset')" style="cursor:pointer;padding:20px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:16px;transition:all 0.2s;">
            <div style="font-size:32px;margin-bottom:12px;">üîê</div>
            <h4 style="color:#fff;font-size:15px;margin-bottom:4px;">Password Reset</h4>
            <p style="font-size:12px;color:rgba(255,255,255,0.5);margin:0;">Sent when user requests password reset</p>
          </div>
          <div class="email-template-card" onclick="showEmailPreview('password_changed')" style="cursor:pointer;padding:20px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:16px;transition:all 0.2s;">
            <div style="font-size:32px;margin-bottom:12px;">üîí</div>
            <h4 style="color:#fff;font-size:15px;margin-bottom:4px;">Password Changed</h4>
            <p style="font-size:12px;color:rgba(255,255,255,0.5);margin:0;">Sent after password is changed</p>
          </div>
        </div>

        <!-- Email Preview Section (hidden by default) -->
        <div id="emailPreviewSection" style="display:none;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
            <button onclick="hideEmailPreview()" style="padding:8px 16px;background:rgba(255,255,255,0.1);border:none;border-radius:8px;color:#fff;cursor:pointer;font-size:13px;">‚Üê Back to templates</button>
            <h3 id="emailPreviewTitle" style="color:#fff;font-size:18px;margin:0;"></h3>
          </div>
          
          <!-- Preview Data Editor -->
          <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:20px;">
            <h4 style="font-size:14px;color:rgba(255,255,255,0.6);margin-bottom:16px;">Preview Data (edit to see changes)</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(180px, 1fr));gap:16px;">
              <div>
                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px;">Username</label>
                <input type="text" id="previewUsername" value="John" oninput="updateEmailPreview()" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:14px;outline:none;">
              </div>
              <div id="previewProductField" style="display:none;">
                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px;">Product</label>
                <input type="text" id="previewProduct" value="Season Pass 2026" oninput="updateEmailPreview()" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:14px;outline:none;">
              </div>
              <div id="previewPriceField" style="display:none;">
                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px;">Price (‚Ç¨)</label>
                <input type="text" id="previewPrice" value="299" oninput="updateEmailPreview()" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:14px;outline:none;">
              </div>
              <div id="previewNewsTitleField" style="display:none;">
                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px;">News Title</label>
                <input type="text" id="previewNewsTitle" value="Summer Camp 2026 üèÑ" oninput="updateEmailPreview()" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:14px;outline:none;">
              </div>
              <div id="previewNewsMessageField" style="display:none;">
                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px;">News Message</label>
                <input type="text" id="previewNewsMessage" value="Join us for an amazing wakeboarding camp!" oninput="updateEmailPreview()" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:14px;outline:none;">
              </div>
              <div id="previewAchievementField" style="display:none;">
                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px;">Achievement Name</label>
                <input type="text" id="previewAchievement" value="Trick Master" oninput="updateEmailPreview()" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:14px;outline:none;">
              </div>
              <div id="previewTierField" style="display:none;">
                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px;">Tier</label>
                <select id="previewTier" onchange="updateEmailPreview()" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:14px;outline:none;">
                  <option value="Bronze">Bronze</option>
                  <option value="Silver">Silver</option>
                  <option value="Gold" selected>Gold</option>
                  <option value="Platinum">Platinum</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Email Preview Frame -->
          <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px;overflow:hidden;">
            <div style="padding:12px 16px;background:rgba(255,255,255,0.05);border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;gap:8px;">
              <div style="width:10px;height:10px;border-radius:50%;background:#ef4444;"></div>
              <div style="width:10px;height:10px;border-radius:50%;background:#fbbf24;"></div>
              <div style="width:10px;height:10px;border-radius:50%;background:#22c55e;"></div>
              <span style="margin-left:12px;font-size:12px;color:rgba(255,255,255,0.5);">Email Preview</span>
            </div>
            <div id="emailPreviewContent" style="min-height:500px;padding:0;"></div>
          </div>
        </div>
      </div>
      
      <!-- User Details Panel -->
      <div class="panel" id="userDetailsPanel">
        <div class="panel-header">
          <h2 id="userDetailsTitle">üë§ User Details</h2>
          <button class="add-btn" onclick="switchTab('users')">‚Üê Back to Users</button>
        </div>
        
        <!-- User Info Card -->
        <div id="userDetailsCard" style="background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:16px;padding:24px;margin-bottom:24px;">
          <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
            <div id="userDetailsAvatar" style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:700;color:#fff;">?</div>
            <div style="flex:1;min-width:200px;">
              <h3 id="userDetailsName" style="font-size:24px;color:#fff;margin-bottom:4px;">Loading...</h3>
              <div id="userDetailsEmail" style="font-size:14px;color:rgba(255,255,255,0.5);margin-bottom:8px;"></div>
              <div id="userDetailsRoles" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
            </div>
            <div style="text-align:right;">
              <div id="userDetailsIds" style="font-size:11px;color:rgba(255,255,255,0.4);"></div>
              <div id="userDetailsJoined" style="font-size:12px;color:rgba(255,255,255,0.5);margin-top:4px;"></div>
            </div>
          </div>
        </div>
        
        <!-- Stats Cards -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;margin-bottom:24px;">
          <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:12px;padding:16px;text-align:center;">
            <div style="font-size:28px;font-weight:700;color:#3b82f6;" id="statCommentsWritten">0</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.5);">Comments Written</div>
          </div>
          <div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:12px;padding:16px;text-align:center;">
            <div style="font-size:28px;font-weight:700;color:#22c55e;" id="statCommentsReceived">0</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.5);">Comments Received</div>
          </div>
          <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);border-radius:12px;padding:16px;text-align:center;">
            <div style="font-size:28px;font-weight:700;color:#f59e0b;" id="statFollowing">0</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.5);">Following</div>
          </div>
          <div style="background:rgba(236,72,153,0.1);border:1px solid rgba(236,72,153,0.2);border-radius:12px;padding:16px;text-align:center;">
            <div style="font-size:28px;font-weight:700;color:#ec4899;" id="statFollowers">0</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.5);">Followers</div>
          </div>
        </div>
        
        <!-- Sub-tabs -->
        <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;">
          <button class="detail-tab active" data-detail-tab="written" onclick="switchDetailTab('written')" style="padding:10px 18px;border-radius:20px;font-size:13px;font-weight:600;border:none;cursor:pointer;background:linear-gradient(135deg,#8b5cf6,#a78bfa);color:#fff;">‚úçÔ∏è Comments Written</button>
          <button class="detail-tab" data-detail-tab="received" onclick="switchDetailTab('received')" style="padding:10px 18px;border-radius:20px;font-size:13px;font-weight:600;border:none;cursor:pointer;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);">üì• Comments Received</button>
          <button class="detail-tab" data-detail-tab="following" onclick="switchDetailTab('following')" style="padding:10px 18px;border-radius:20px;font-size:13px;font-weight:600;border:none;cursor:pointer;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);">üë• Following</button>
          <button class="detail-tab" data-detail-tab="followers" onclick="switchDetailTab('followers')" style="padding:10px 18px;border-radius:20px;font-size:13px;font-weight:600;border:none;cursor:pointer;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);">‚ù§Ô∏è Followers</button>
        </div>
        
        <!-- Comments Written Table -->
        <div class="detail-panel active" id="writtenPanel">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Content</th>
                  <th>Type</th>
                  <th>Target</th>
                  <th>To User</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="commentsWrittenTable">
                <tr><td colspan="7" class="loading">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Comments Received Table -->
        <div class="detail-panel" id="receivedPanel">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Content</th>
                  <th>Type</th>
                  <th>Target</th>
                  <th>From User</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="commentsReceivedTable">
                <tr><td colspan="7" class="loading">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Following Table -->
        <div class="detail-panel" id="followingPanel">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Avatar</th>
                  <th>Username</th>
                  <th>Display Name</th>
                  <th>Roles</th>
                  <th>Following Since</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="followingTable">
                <tr><td colspan="6" class="loading">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Followers Table -->
        <div class="detail-panel" id="followersPanel">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Avatar</th>
                  <th>Username</th>
                  <th>Display Name</th>
                  <th>Roles</th>
                  <th>Following Since</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="followersTable">
                <tr><td colspan="6" class="loading">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Modal -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="userModalTitle">Add User</h3>
        <button class="close-btn" onclick="closeModal('userModal')">&times;</button>
      </div>
      <input type="hidden" id="userId">
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="userUsername" placeholder="johndoe">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="userEmail" placeholder="john@example.com">
      </div>
      <div class="form-group">
        <label>Password (leave empty to keep current)</label>
        <input type="password" id="userPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="userIsAdmin" style="width:auto;">
          Admin privileges
        </label>
      </div>
      <div class="form-group">
        <label style="margin-bottom:12px;color:rgba(255,255,255,0.7);">User Roles</label>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);border-radius:8px;cursor:pointer;">
            <input type="checkbox" id="userIsCoach" style="width:18px;height:18px;">
            <span style="color:#f59e0b;font-weight:600;">üéì Coach</span>
            <span style="font-size:11px;color:rgba(255,255,255,0.5);margin-left:auto;">Can create events</span>
          </label>
          <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:8px;cursor:pointer;">
            <input type="checkbox" id="userIsStaff" style="width:18px;height:18px;">
            <span style="color:#3b82f6;font-weight:600;">üë§ Staff</span>
            <span style="font-size:11px;color:rgba(255,255,255,0.5);margin-left:auto;">Park employee</span>
          </label>
          <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:8px;cursor:pointer;">
            <input type="checkbox" id="userIsClubMember" style="width:18px;height:18px;">
            <span style="color:#8b5cf6;font-weight:600;">‚≠ê Club Member</span>
            <span style="font-size:11px;color:rgba(255,255,255,0.5);margin-left:auto;">Exclusive member</span>
          </label>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
        <button class="btn" onclick="saveUser()">Save</button>
      </div>
    </div>
  </div>

  <!-- Trick Modal -->
  <div class="modal" id="trickModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="trickModalTitle">Add Trick</h3>
        <button class="close-btn" onclick="closeModal('trickModal')">&times;</button>
      </div>
      <input type="hidden" id="trickId">
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="trickName" placeholder="Surface 180">
      </div>
      <div class="form-group">
        <label>Category</label>
        <select id="trickCategory">
          <option value="courses">Courses</option>
          <option value="preparation">Preparation</option>
          <option value="surface">Surface</option>
          <option value="rail_obstacle">Rail / Obstacle</option>
          <option value="ollie">Ollie</option>
          <option value="air">Air</option>
          <option value="kicker_grabs">Kicker - Grabs</option>
          <option value="kicker_rotation">Kicker - Rotation</option>
          <option value="kicker_invert">Kicker - Invert</option>
        </select>
      </div>
      <div class="form-group">
        <label>Difficulty</label>
        <select id="trickDifficulty">
          <option value="beginner">Beginner</option>
          <option value="intermediate">Intermediate</option>
          <option value="advanced">Advanced</option>
        </select>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="trickDescription" rows="2" placeholder="Short description..."></textarea>
      </div>
      <div class="form-group">
        <label>Position (sort order within category, e.g. 1, 2, 3.5)</label>
        <input type="number" id="trickPosition" step="0.01" placeholder="0" style="width:120px">
      </div>
      <div class="form-group">
        <label style="margin-bottom:8px;display:block">Content Sections <span style="font-weight:normal;color:#999">(empty sections are hidden from users)</span></label>
        <div id="trickSectionsContainer"></div>
      </div>
      <div class="form-group">
        <label>Video URL (optional)</label>
        <input type="text" id="trickVideoUrl" placeholder="https://...">
      </div>
      <div class="form-group">
        <label>Image URL (optional)</label>
        <input type="text" id="trickImageUrl" placeholder="https://... (cover image for the trick card)">
        <div id="trickImagePreview" style="margin-top:8px;display:none"><img style="max-width:100%;max-height:120px;border-radius:8px;border:1px solid rgba(139,92,246,0.3)" /></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('trickModal')">Cancel</button>
        <button class="btn" onclick="saveTrick()">Save</button>
      </div>
    </div>
  </div>

  <!-- Event Modal -->
  <div class="modal" id="eventModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="eventModalTitle">Add Event</h3>
        <button class="close-btn" onclick="closeModal('eventModal')">&times;</button>
      </div>
      <input type="hidden" id="eventId">
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="eventName" placeholder="Morning Session">
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="eventDate">
      </div>
      <div class="form-group">
        <label>Time</label>
        <input type="time" id="eventTime">
      </div>
      <div class="form-group">
        <label>Location</label>
        <input type="text" id="eventLocation" placeholder="Flat Water">
      </div>
      <div class="form-group">
        <label>Location URL (optional)</label>
        <input type="text" id="eventLocationUrl" placeholder="https://...">
      </div>
      <div class="form-group">
        <label>Spots</label>
        <input type="number" id="eventSpots" placeholder="10" min="1">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('eventModal')">Cancel</button>
        <button class="btn" onclick="saveEvent()">Save</button>
      </div>
    </div>
  </div>

  <!-- News Modal -->
  <div class="modal" id="newsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="newsModalTitle">Add News</h3>
        <button class="close-btn" onclick="closeModal('newsModal')">&times;</button>
      </div>
      <input type="hidden" id="newsId">
      <div class="form-group">
        <label>Title</label>
        <input type="text" id="newsTitle" placeholder="Summer Camp 2026">
      </div>
      <div class="form-group">
        <label>Type</label>
        <select id="newsType">
          <option value="info">Info</option>
          <option value="event">Event</option>
          <option value="achievement">Achievement</option>
        </select>
      </div>
      <div class="form-group">
        <label>Icon</label>
        <input type="hidden" id="newsEmoji">
        <div class="emoji-picker" id="emojiPicker">
          <button type="button" class="emoji-btn" onclick="selectEmoji('üì¢')">üì¢</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('üéâ')">üéâ</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('üèÜ')">üèÜ</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('‚≠ê')">‚≠ê</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('üèÑ')">üèÑ</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('üåä')">üåä</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('üìÖ')">üìÖ</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('‚è∞')">‚è∞</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('üèÉ')">üèÉ</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('üí™')">üí™</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('üî•')">üî•</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('‚úÖ')">‚úÖ</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('‚ö†Ô∏è')">‚ö†Ô∏è</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('üéØ')">üéØ</button>
          <button type="button" class="emoji-btn" onclick="selectEmoji('üöÄ')">üöÄ</button>
        </div>
      </div>
      <div class="form-group">
        <label>Message</label>
        <textarea id="newsMessage" rows="3" placeholder="Short message..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('newsModal')">Cancel</button>
        <button class="btn" onclick="saveNews()">Save</button>
      </div>
    </div>
  </div>

  <!-- Article Modal -->
  <div class="modal" id="articleModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="articleModalTitle">Add Article</h3>
        <button class="close-btn" onclick="closeModal('articleModal')">&times;</button>
      </div>
      <input type="hidden" id="articleId">
      <div class="form-group">
        <label>Title</label>
        <input type="text" id="articleTitle" placeholder="Finding Your Center">
      </div>
      <div class="form-group">
        <label>Category</label>
        <select id="articleCategory">
          <option value="balance">Balance</option>
          <option value="body">Body Position</option>
          <option value="equipment">Equipment</option>
          <option value="obstacle">Obstacles</option>
          <option value="stance">Stance</option>
          <option value="safety">Safety</option>
          <option value="courses">Courses</option>
        </select>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="articleDescription" rows="2" placeholder="Short description..."></textarea>
      </div>
      <div class="form-group">
        <label>Content</label>
        <div class="rich-toolbar">
          <button type="button" onclick="insertBullet('articleContent')">‚Ä¢ Bullet</button>
          <button type="button" onclick="insertLink('articleContent')">üîó Link</button>
          <span class="hint">Use - for bullets, [text](url) for links</span>
        </div>
        <textarea id="articleContent" rows="8" placeholder="Full article content...&#10;&#10;- Key point one&#10;- Key point two&#10;&#10;More info: [visit site](https://example.com)"></textarea>
      </div>
      <div class="form-group">
        <label>Read Time</label>
        <input type="text" id="articleReadTime" placeholder="5 min">
      </div>
      <div class="form-group">
        <label>Image URL (optional)</label>
        <input type="text" id="articleImageUrl" placeholder="https://... (cover image for the article card)">
        <div id="articleImagePreview" style="margin-top:8px;display:none"><img style="max-width:100%;max-height:120px;border-radius:8px;border:1px solid rgba(139,92,246,0.3)" /></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('articleModal')">Cancel</button>
        <button class="btn" onclick="saveArticle()">Save</button>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal" id="productModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="productModalTitle">Add Product</h3>
        <button class="close-btn" onclick="closeModal('productModal')">&times;</button>
      </div>
      <input type="hidden" id="productId">
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="productName" placeholder="1h Pass">
      </div>
      <div class="form-group">
        <label>Category</label>
        <select id="productCategory">
          <option value="cable">Cable</option>
          <option value="activities">Activities</option>
          <option value="events">Events</option>
          <option value="clothes">Clothes</option>
        </select>
      </div>
      <div class="form-group">
        <label>Price (‚Ç¨)</label>
        <input type="number" step="0.01" id="productPrice" placeholder="25.00">
      </div>
      <div class="form-group">
        <label>Duration (optional)</label>
        <input type="text" id="productDuration" placeholder="1h">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="productDescription" rows="3" placeholder="Product description..."></textarea>
      </div>
      <div class="form-group">
        <label>Icon (emoji)</label>
        <input type="text" id="productIcon" placeholder="üéø">
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="productActive" checked style="width:auto;">
          Active (visible in shop)
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('productModal')">Cancel</button>
        <button class="btn" onclick="saveProduct()">Save</button>
      </div>
    </div>
  </div>

  <!-- Grant Achievement Modal -->
  <div class="modal" id="grantAchievementModal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>üèÜ Grant Achievements</h3>
        <button class="close-btn" onclick="closeModal('grantAchievementModal')">&times;</button>
      </div>
      <input type="hidden" id="grantAchievementUserId">
      <p style="margin-bottom: 16px; color: rgba(255,255,255,0.7);">
        Grant special achievements to <strong id="grantAchievementUsername"></strong>
      </p>
      <div id="achievementOptions" style="margin-bottom: 16px;">
        <!-- Achievement options will be rendered here -->
      </div>
      <div class="form-group">
        <label>Note (optional)</label>
        <input type="text" id="grantAchievementNote" placeholder="e.g., Wings for Life 2025 participant">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('grantAchievementModal')">Cancel</button>
        <button class="btn" onclick="submitGrantAchievements()">Grant Selected</button>
      </div>
    </div>
  </div>

  <!-- RFID Bands Modal -->
  <div class="modal" id="bandsModal">
    <div class="modal-content" style="max-width: 550px;">
      <div class="modal-header">
        <h3>üè∑Ô∏è RFID Wristbands</h3>
        <button class="close-btn" onclick="closeModal('bandsModal')">&times;</button>
      </div>
      <input type="hidden" id="bandsUserId">
      <p style="margin-bottom: 16px; color: rgba(255,255,255,0.7);">
        Wristbands linked to <strong id="bandsUsername"></strong>
      </p>
      <div id="bandsList" style="margin-bottom: 16px; max-height: 400px; overflow-y: auto;">
        <!-- Bands will be rendered here -->
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('bandsModal')">Close</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://lunar-production-f237.up.railway.app/api';
    let authToken = localStorage.getItem('admin_token');
    let currentUser = null;

    // ============ AUTH ============
    
    async function handleLogin() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      const btnEl = document.getElementById('loginBtn');
      
      if (!email || !password) {
        errorEl.textContent = 'Please enter email and password';
        errorEl.classList.add('show');
        return;
      }
      
      btnEl.disabled = true;
      btnEl.textContent = 'Logging in...';
      errorEl.classList.remove('show');
      
      try {
        const res = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || 'Login failed');
        }
        
        if (!data.user.is_admin) {
          throw new Error('Access denied. Admin privileges required.');
        }
        
        authToken = data.token;
        currentUser = data.user;
        localStorage.setItem('admin_token', authToken);
        
        showAdminPanel();
        
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.classList.add('show');
      } finally {
        btnEl.disabled = false;
        btnEl.textContent = 'Login';
      }
    }
    
    function handleLogout() {
      authToken = null;
      currentUser = null;
      localStorage.removeItem('admin_token');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('adminPanel').classList.remove('active');
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
    }
    
    function showAdminPanel() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('panelSelection').classList.add('active');
      document.getElementById('adminPanel').classList.remove('active');
    }
    
    function goToAdminPanel() {
      document.getElementById('panelSelection').classList.remove('active');
      document.getElementById('adminPanel').classList.add('active');
      
      // Set user info in header
      const username = currentUser?.username || currentUser?.email?.split('@')[0] || 'Admin';
      document.getElementById('adminUsername').textContent = username;
      document.getElementById('adminAvatar').textContent = username[0]?.toUpperCase() || 'A';
      
      loadAllData();
    }
    
    function goToSalesPanel() {
      // Redirect to sales panel
      window.location.href = '../sales/';
    }
    
    function goToHowtoPanel() {
      // Redirect to howto panel
      window.location.href = '../howto/';
    }
    
    function goToTestV2() {
      window.location.href = '/test.html';
    }
    
    function goBackToSelection() {
      document.getElementById('adminPanel').classList.remove('active');
      document.getElementById('panelSelection').classList.add('active');
    }
    
    async function checkAuth() {
      if (!authToken) return;
      
      try {
        const res = await fetch(`${API_URL}/auth/me`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!res.ok) throw new Error('Invalid token');
        
        const data = await res.json();
        
        if (!data.user.is_admin) {
          throw new Error('Not admin');
        }
        
        currentUser = data.user;
        showAdminPanel();
        
      } catch (err) {
        localStorage.removeItem('admin_token');
        authToken = null;
      }
    }

    // ============ TOAST NOTIFICATIONS ============
    
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; padding: 16px 24px; 
        background: ${type === 'error' ? '#ef4444' : '#22c55e'}; 
        color: white; border-radius: 8px; font-weight: 500; z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slideIn 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ============ LIVE SEARCH FILTER ============
    
    function filterTable(tableId, searchTerm) {
      const table = document.getElementById(tableId);
      if (!table) return;
      
      const rows = table.querySelectorAll('tr');
      const term = searchTerm.toLowerCase().trim();
      
      rows.forEach(row => {
        // Skip if it's a "loading" or "no results" row
        if (row.querySelector('.loading')) return;
        
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
      });
    }

    // ============ API HELPERS ============
    
    async function apiCall(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        cache: 'no-store',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        }
      };
      if (body) options.body = JSON.stringify(body);
      
      // Cache-bust GET requests to bypass Service Worker
      const url = method === 'GET' 
        ? `${API_URL}${endpoint}${endpoint.includes('?') ? '&' : '?'}_t=${Date.now()}`
        : `${API_URL}${endpoint}`;
      
      const res = await fetch(url, options);
      if (!res.ok) {
        let msg = `HTTP ${res.status}`;
        try { const data = await res.json(); msg = data.error || msg; } catch(e) {}
        throw new Error(msg);
      }
      // Safely parse JSON ‚Äî handle empty responses
      const text = await res.text();
      if (!text) return { success: true };
      try { return JSON.parse(text); } catch(e) { return { success: true, raw: text }; }
    }

    // ============ DATA LOADING ============
    
    function loadAllData() {
      loadPendingUsers();
      loadUsers();
      loadTricks();
      loadEvents();
      loadNews();
      loadArticles();
      loadProducts();
    }
    
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.getElementById(`${tab}Panel`).classList.add('active');
      
      // Lazy load achievements stats
      if (tab === 'achievements') {
        loadAchievementsStats();
      }
      
      // Lazy load comments
      if (tab === 'comments') {
        loadAllComments();
      }
    }
    
    // ============ RICH TEXT HELPERS ============

    function insertAtCursor(textareaId, before, after = '') {
      const ta = document.getElementById(textareaId);
      const start = ta.selectionStart;
      const end = ta.selectionEnd;
      const selected = ta.value.substring(start, end);
      const text = before + (selected || '') + after;
      ta.setRangeText(text, start, end, 'end');
      ta.focus();
    }

    function insertBullet(textareaId) {
      const ta = document.getElementById(textareaId);
      const start = ta.selectionStart;
      // If cursor is not at start of line, add newline first
      const prefix = (start > 0 && ta.value[start - 1] !== '\n') ? '\n' : '';
      insertAtCursor(textareaId, prefix + '- ');
    }

    function insertLink(textareaId) {
      const ta = document.getElementById(textareaId);
      const selected = ta.value.substring(ta.selectionStart, ta.selectionEnd);
      const linkText = selected || prompt('Link text:', 'click here');
      if (!linkText) return;
      const url = prompt('URL:', 'https://');
      if (!url) return;
      insertAtCursor(textareaId, `[${linkText}](${url})`);
    }

    function showImagePreview(inputId, previewId) {
      const url = document.getElementById(inputId).value.trim();
      const preview = document.getElementById(previewId);
      if (url) {
        preview.style.display = 'block';
        preview.querySelector('img').src = url;
        preview.querySelector('img').onerror = () => { preview.style.display = 'none'; };
      } else {
        preview.style.display = 'none';
      }
    }

    // Live image preview on URL input
    document.addEventListener('DOMContentLoaded', () => {
      ['trickImageUrl', 'articleImageUrl'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', () => showImagePreview(id, id.replace('Url', 'Preview')));
      });
    });

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // ============ PENDING APPROVALS ============
    
    async function loadPendingUsers() {
      try {
        const users = await apiCall('/admin/pending-users');
        const count = users.length;
        
        // Update count display
        document.getElementById('pendingCount').innerHTML = count > 0 
          ? `<strong>${count}</strong> user${count === 1 ? '' : 's'} waiting for approval`
          : '‚úÖ No pending approvals';
        
        // Update tab badge
        const pendingTab = document.querySelector('[data-tab="pending"]');
        pendingTab.textContent = count > 0 ? `üîî Pending (${count})` : 'üîî Pending';
        
        document.getElementById('pendingUsersTable').innerHTML = users.length > 0 
          ? users.map(u => `
            <tr>
              <td><strong>${u.username || '-'}</strong></td>
              <td>${u.email || '-'}</td>
              <td>${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}</td>
              <td>
                <button class="action-btn edit" onclick="approveUser(${u.id}, '${u.username}')" title="Approve">‚úì Approve</button>
                <button class="action-btn delete" onclick="rejectUser(${u.id}, '${u.username}')" title="Reject">‚úó Reject</button>
              </td>
            </tr>
          `).join('')
          : '<tr><td colspan="4" class="loading">No pending approvals üéâ</td></tr>';
      } catch (err) {
        console.error('Failed to load pending users:', err);
        document.getElementById('pendingUsersTable').innerHTML = '<tr><td colspan="4" class="loading">Failed to load pending users</td></tr>';
      }
    }
    
    async function approveUser(id, username) {
      if (!confirm(`Approve user "${username}"? They will be able to log in.`)) return;
      try {
        await apiCall(`/admin/approve-user/${id}`, 'POST');
        showToast(`User "${username}" approved!`);
        loadPendingUsers();
        loadUsers(); // Refresh main users list too
      } catch (err) {
        showToast('Failed to approve user: ' + err.message, 'error');
      }
    }
    
    async function rejectUser(id, username) {
      if (!confirm(`Reject and DELETE user "${username}"? This cannot be undone.`)) return;
      try {
        await apiCall(`/admin/reject-user/${id}`, 'DELETE');
        showToast(`User "${username}" rejected and removed.`);
        loadPendingUsers();
      } catch (err) {
        showToast('Failed to reject user: ' + err.message, 'error');
      }
    }

    // ============ USERS ============
    
    async function loadUsers() {
      try {
        const users = await apiCall('/admin/users');
        document.getElementById('usersTable').innerHTML = users.map(u => {
          const lastLogin = u.last_login ? new Date(u.last_login).toLocaleDateString() + ' ' + new Date(u.last_login).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Never';
          const statusBadge = u.is_blocked 
            ? '<span class="badge" style="background:rgba(239,68,68,0.2);color:#ef4444;">Blocked</span>'
            : '<span class="badge" style="background:rgba(34,197,94,0.2);color:#22c55e;">Active</span>';
          const blockBtn = u.is_blocked
            ? `<button class="action-btn" style="background:rgba(34,197,94,0.2);color:#22c55e;" onclick="unblockUser(${u.id})">Unblock</button>`
            : `<button class="action-btn" style="background:rgba(239,68,68,0.2);color:#ef4444;" onclick="blockUser(${u.id})">Block</button>`;
          
          // Role badges
          let roleBadges = u.is_admin ? '<span class="badge badge-admin">Admin</span>' : '';
          if (u.is_coach) roleBadges += '<span class="badge" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;font-size:10px;">Coach</span>';
          if (u.is_staff) roleBadges += '<span class="badge" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;font-size:10px;">Staff</span>';
          if (u.is_club_member) roleBadges += '<span class="badge" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff;font-size:10px;">Member</span>';
          if (!roleBadges) roleBadges = '<span class="badge badge-user">User</span>';
          
          return `
          <tr id="user-row-${u.id}">
            <td><code class="public-id">${u.public_id || '-'}</code></td>
            <td><div class="avatar-small">${u.username?.[0]?.toUpperCase() || '?'}</div></td>
            <td>${u.username || '-'}</td>
            <td>${u.email}</td>
            <td>${u.birthdate ? new Date(u.birthdate).toLocaleDateString() : '-'}</td>
            <td style="display:flex;gap:4px;flex-wrap:wrap;">${roleBadges}</td>
            <td style="font-size:12px;color:#888;">${lastLogin}</td>
            <td>${statusBadge}</td>
            <td class="actions" style="display:flex;gap:4px;flex-wrap:wrap;">
              <button class="action-btn" style="background:rgba(16,185,129,0.2);color:#10b981;font-size:11px;padding:4px 8px;" onclick="showUserDetails(${u.id})">üë§ Details</button>
              <button class="action-btn" style="background:rgba(139,92,246,0.2);color:#a78bfa;font-size:11px;padding:4px 8px;" onclick="showUserSales(${u.id}, '${u.username}')">Sales</button>
              <button class="action-btn" style="background:rgba(59,130,246,0.2);color:#3b82f6;font-size:11px;padding:4px 8px;" onclick="showUserEvents(${u.id}, '${u.username}')">Events</button>
              <button class="action-btn" style="background:rgba(251,191,36,0.2);color:#fbbf24;font-size:11px;padding:4px 8px;" onclick="showUserLogs(${u.id}, '${u.username}')">Logs</button>
              <button class="action-btn" style="background:rgba(236,72,153,0.2);color:#ec4899;font-size:11px;padding:4px 8px;" onclick="showUserBands(${u.id}, '${u.username}')">üè∑Ô∏è Bands</button>
              <button class="action-btn" style="background:rgba(0,206,209,0.2);color:#00CED1;font-size:11px;padding:4px 8px;" onclick="openGrantAchievementModal(${u.id}, '${u.username}')">üèÜ</button>
              <button class="action-btn edit-btn" onclick="editUser(${u.id})">Edit</button>
              ${blockBtn}
              <button class="action-btn delete-btn" onclick="deleteUser(${u.id})">Delete</button>
            </td>
          </tr>
        `}).join('') || '<tr><td colspan="10" class="loading">No users found</td></tr>';
      } catch (err) {
        document.getElementById('usersTable').innerHTML = '<tr><td colspan="10" class="loading">Failed to load users</td></tr>';
      }
    }

    // Block user
    async function blockUser(id) {
      if (!confirm('Are you sure you want to block this user?')) return;
      try {
        await apiCall(`/admin/users/${id}/block`, 'POST');
        loadUsers();
        alert('User blocked successfully');
      } catch (err) {
        alert('Failed to block user: ' + err.message);
      }
    }

    // Unblock user
    async function unblockUser(id) {
      if (!confirm('Are you sure you want to unblock this user?')) return;
      try {
        await apiCall(`/admin/users/${id}/unblock`, 'POST');
        loadUsers();
        alert('User unblocked successfully');
      } catch (err) {
        alert('Failed to unblock user: ' + err.message);
      }
    }

    // ============ ALL COMMENTS ============
    
    let allCommentsData = [];
    let currentCommentFilter = 'all';
    
    async function loadAllComments() {
      try {
        const data = await apiCall('/admin/comments');
        allCommentsData = data.comments || [];
        
        // Update stats
        const total = allCommentsData.length;
        const active = allCommentsData.filter(c => !c.is_deleted).length;
        const deleted = allCommentsData.filter(c => c.is_deleted).length;
        const trickComments = allCommentsData.filter(c => c.comment_type === 'trick').length;
        const achievementComments = allCommentsData.filter(c => c.comment_type === 'achievement').length;
        
        document.getElementById('commentsTotal').textContent = total;
        document.getElementById('commentsActive').textContent = active;
        document.getElementById('commentsDeleted').textContent = deleted;
        document.getElementById('commentsTrick').textContent = trickComments;
        document.getElementById('commentsAchievement').textContent = achievementComments;
        
        renderComments(allCommentsData);
      } catch (err) {
        document.getElementById('allCommentsTable').innerHTML = '<tr><td colspan="8" class="loading">Failed to load comments</td></tr>';
      }
    }
    
    function filterComments(filter) {
      currentCommentFilter = filter;
      
      // Update filter button styles
      document.querySelectorAll('.comment-filter').forEach(btn => {
        btn.style.background = 'rgba(255,255,255,0.08)';
        btn.style.color = 'rgba(255,255,255,0.6)';
        btn.classList.remove('active');
      });
      const activeBtn = document.querySelector(`[data-filter="${filter}"]`);
      activeBtn.style.background = 'linear-gradient(135deg,#8b5cf6,#a78bfa)';
      activeBtn.style.color = '#fff';
      activeBtn.classList.add('active');
      
      // Filter data
      let filtered = allCommentsData;
      if (filter === 'active') {
        filtered = allCommentsData.filter(c => !c.is_deleted);
      } else if (filter === 'deleted') {
        filtered = allCommentsData.filter(c => c.is_deleted);
      } else if (filter === 'trick') {
        filtered = allCommentsData.filter(c => c.comment_type === 'trick');
      } else if (filter === 'achievement') {
        filtered = allCommentsData.filter(c => c.comment_type === 'achievement');
      }
      
      renderComments(filtered);
    }
    
    function searchComments(query) {
      if (!query.trim()) {
        filterComments(currentCommentFilter);
        return;
      }
      
      const q = query.toLowerCase();
      let filtered = allCommentsData.filter(c => 
        c.content?.toLowerCase().includes(q) ||
        c.author_username?.toLowerCase().includes(q) ||
        c.owner_username?.toLowerCase().includes(q) ||
        c.trick_name?.toLowerCase().includes(q) ||
        c.achievement_id?.toLowerCase().includes(q)
      );
      
      // Apply current filter too
      if (currentCommentFilter === 'active') {
        filtered = filtered.filter(c => !c.is_deleted);
      } else if (currentCommentFilter === 'deleted') {
        filtered = filtered.filter(c => c.is_deleted);
      } else if (currentCommentFilter === 'trick') {
        filtered = filtered.filter(c => c.comment_type === 'trick');
      } else if (currentCommentFilter === 'achievement') {
        filtered = filtered.filter(c => c.comment_type === 'achievement');
      }
      
      renderComments(filtered);
    }
    
    function renderComments(comments) {
      const table = document.getElementById('allCommentsTable');
      
      if (comments.length === 0) {
        table.innerHTML = '<tr><td colspan="8" class="loading">No comments found</td></tr>';
        return;
      }
      
      table.innerHTML = comments.map(c => {
        const status = c.is_deleted 
          ? `<span class="status-deleted">Deleted</span>` 
          : `<span class="status-active">Active</span>`;
        const typeBadge = c.comment_type === 'trick' 
          ? '<span class="type-badge type-trick">üéØ Trick</span>'
          : '<span class="type-badge type-achievement">üèÜ Achievement</span>';
        const target = c.trick_name || c.achievement_id || '-';
        const date = new Date(c.created_at).toLocaleString();
        
        const deleteBtn = c.is_deleted
          ? `<button class="action-btn" style="background:rgba(34,197,94,0.2);color:#22c55e;font-size:11px;padding:4px 8px;" onclick="restoreCommentGlobal('${c.comment_type}', ${c.id})">Restore</button>`
          : `<button class="action-btn" style="background:rgba(239,68,68,0.2);color:#ef4444;font-size:11px;padding:4px 8px;" onclick="deleteCommentGlobal('${c.comment_type}', ${c.id})">Delete</button>`;
        
        return `
          <tr>
            <td>${status}</td>
            <td style="font-size:12px;color:#888;">${date}</td>
            <td>
              <span style="cursor:pointer;color:#a78bfa;" onclick="showUserDetails(${c.author_id})">@${c.author_username}</span>
            </td>
            <td class="comment-content" title="${c.content?.replace(/"/g, '&quot;')}">${c.content || '-'}</td>
            <td>${typeBadge}</td>
            <td>${target}</td>
            <td>
              <span style="cursor:pointer;color:#a78bfa;" onclick="showUserDetails(${c.owner_id})">@${c.owner_username}</span>
            </td>
            <td>${deleteBtn}</td>
          </tr>
        `;
      }).join('');
    }
    
    async function deleteCommentGlobal(type, commentId) {
      if (!confirm('Delete this comment?')) return;
      try {
        await apiCall(`/admin/comments/${type}/${commentId}`, 'DELETE');
        showToast('Comment deleted');
        loadAllComments();
      } catch (err) {
        showToast('Failed to delete: ' + err.message, 'error');
      }
    }
    
    async function restoreCommentGlobal(type, commentId) {
      if (!confirm('Restore this comment?')) return;
      try {
        await apiCall(`/admin/comments/${type}/${commentId}/restore`, 'POST');
        showToast('Comment restored');
        loadAllComments();
      } catch (err) {
        showToast('Failed to restore: ' + err.message, 'error');
      }
    }

    // ============ USER DETAILS ============
    
    let currentDetailUserId = null;
    
    async function showUserDetails(userId) {
      currentDetailUserId = userId;
      
      // Show tab and switch to it
      document.getElementById('userDetailsTab').style.display = 'block';
      switchTab('userDetails');
      
      // Load user details
      try {
        const data = await apiCall(`/admin/users/${userId}/details`);
        const user = data.user;
        const stats = data.stats;
        
        // Update UI
        document.getElementById('userDetailsTitle').textContent = `üë§ ${user.display_name || user.username}`;
        document.getElementById('userDetailsAvatar').textContent = (user.username?.[0] || '?').toUpperCase();
        document.getElementById('userDetailsName').textContent = user.display_name || user.username;
        document.getElementById('userDetailsEmail').textContent = user.email;
        document.getElementById('userDetailsIds').innerHTML = `ID: ${user.id} | ${user.public_id || 'N/A'}`;
        document.getElementById('userDetailsJoined').textContent = `Joined: ${new Date(user.created_at).toLocaleDateString()}`;
        
        // Role badges
        let roleBadges = '';
        if (user.is_admin) roleBadges += '<span class="badge badge-admin">Admin</span>';
        if (user.is_coach) roleBadges += '<span class="badge" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;">Coach</span>';
        if (user.is_staff) roleBadges += '<span class="badge" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;">Staff</span>';
        if (user.is_club_member) roleBadges += '<span class="badge" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff;">Member</span>';
        if (!roleBadges) roleBadges = '<span class="badge badge-user">User</span>';
        document.getElementById('userDetailsRoles').innerHTML = roleBadges;
        
        // Stats
        document.getElementById('statCommentsWritten').textContent = stats.commentsWritten.total || 0;
        document.getElementById('statCommentsReceived').textContent = stats.commentsReceived.total || 0;
        document.getElementById('statFollowing').textContent = stats.following || 0;
        document.getElementById('statFollowers').textContent = stats.followers || 0;
        
        // Load comments written by default
        loadCommentsWritten(userId);
        
      } catch (err) {
        showToast('Failed to load user details: ' + err.message, 'error');
      }
    }
    
    function switchDetailTab(tab) {
      // Update tab styles
      document.querySelectorAll('.detail-tab').forEach(t => {
        t.classList.remove('active');
        t.style.background = 'rgba(255,255,255,0.08)';
        t.style.color = 'rgba(255,255,255,0.6)';
      });
      const activeTab = document.querySelector(`[data-detail-tab="${tab}"]`);
      activeTab.classList.add('active');
      activeTab.style.background = 'linear-gradient(135deg,#8b5cf6,#a78bfa)';
      activeTab.style.color = '#fff';
      
      // Update panels
      document.querySelectorAll('.detail-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(`${tab}Panel`).classList.add('active');
      
      // Load data
      if (tab === 'written') loadCommentsWritten(currentDetailUserId);
      else if (tab === 'received') loadCommentsReceived(currentDetailUserId);
      else if (tab === 'following') loadFollowing(currentDetailUserId);
      else if (tab === 'followers') loadFollowers(currentDetailUserId);
    }
    
    async function loadCommentsWritten(userId) {
      try {
        const data = await apiCall(`/admin/users/${userId}/comments/written`);
        const table = document.getElementById('commentsWrittenTable');
        
        if (data.comments.length === 0) {
          table.innerHTML = '<tr><td colspan="7" class="loading">No comments written</td></tr>';
          return;
        }
        
        table.innerHTML = data.comments.map(c => {
          const status = c.is_deleted 
            ? `<span class="status-deleted">Deleted</span>` 
            : `<span class="status-active">Active</span>`;
          const typeBadge = c.comment_type === 'trick' 
            ? '<span class="type-badge type-trick">üéØ Trick</span>'
            : '<span class="type-badge type-achievement">üèÜ Achievement</span>';
          const target = c.trick_name || c.achievement_id || '-';
          const date = new Date(c.created_at).toLocaleString();
          const targetUser = c.target_display_name || c.target_username || '-';
          
          const deleteBtn = c.is_deleted
            ? `<button class="action-btn" style="background:rgba(34,197,94,0.2);color:#22c55e;font-size:11px;padding:4px 8px;" onclick="restoreComment('${c.comment_type}', ${c.id})">Restore</button>`
            : `<button class="action-btn" style="background:rgba(239,68,68,0.2);color:#ef4444;font-size:11px;padding:4px 8px;" onclick="deleteComment('${c.comment_type}', ${c.id})">Delete</button>`;
          
          return `
            <tr>
              <td>${status}</td>
              <td style="font-size:12px;color:#888;">${date}</td>
              <td class="comment-content" title="${c.content}">${c.content}</td>
              <td>${typeBadge}</td>
              <td>${target}</td>
              <td><strong>@${c.target_username}</strong></td>
              <td>${deleteBtn}</td>
            </tr>
          `;
        }).join('');
      } catch (err) {
        document.getElementById('commentsWrittenTable').innerHTML = '<tr><td colspan="7" class="loading">Failed to load</td></tr>';
      }
    }
    
    async function loadCommentsReceived(userId) {
      try {
        const data = await apiCall(`/admin/users/${userId}/comments/received`);
        const table = document.getElementById('commentsReceivedTable');
        
        if (data.comments.length === 0) {
          table.innerHTML = '<tr><td colspan="7" class="loading">No comments received</td></tr>';
          return;
        }
        
        table.innerHTML = data.comments.map(c => {
          const status = c.is_deleted 
            ? `<span class="status-deleted">Deleted</span>` 
            : `<span class="status-active">Active</span>`;
          const typeBadge = c.comment_type === 'trick' 
            ? '<span class="type-badge type-trick">üéØ Trick</span>'
            : '<span class="type-badge type-achievement">üèÜ Achievement</span>';
          const target = c.trick_name || c.achievement_id || '-';
          const date = new Date(c.created_at).toLocaleString();
          const fromUser = c.from_display_name || c.from_username || '-';
          
          const deleteBtn = c.is_deleted
            ? `<button class="action-btn" style="background:rgba(34,197,94,0.2);color:#22c55e;font-size:11px;padding:4px 8px;" onclick="restoreComment('${c.comment_type}', ${c.id})">Restore</button>`
            : `<button class="action-btn" style="background:rgba(239,68,68,0.2);color:#ef4444;font-size:11px;padding:4px 8px;" onclick="deleteComment('${c.comment_type}', ${c.id})">Delete</button>`;
          
          return `
            <tr>
              <td>${status}</td>
              <td style="font-size:12px;color:#888;">${date}</td>
              <td class="comment-content" title="${c.content}">${c.content}</td>
              <td>${typeBadge}</td>
              <td>${target}</td>
              <td><strong>@${c.from_username}</strong></td>
              <td>${deleteBtn}</td>
            </tr>
          `;
        }).join('');
      } catch (err) {
        document.getElementById('commentsReceivedTable').innerHTML = '<tr><td colspan="7" class="loading">Failed to load</td></tr>';
      }
    }
    
    async function loadFollowing(userId) {
      try {
        const data = await apiCall(`/admin/users/${userId}/social`);
        const table = document.getElementById('followingTable');
        
        if (data.following.length === 0) {
          table.innerHTML = '<tr><td colspan="6" class="loading">Not following anyone</td></tr>';
          return;
        }
        
        table.innerHTML = data.following.map(u => {
          let roleBadges = '';
          if (u.is_admin) roleBadges += '<span class="badge badge-admin" style="font-size:9px;">Admin</span>';
          if (u.is_coach) roleBadges += '<span class="badge" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;font-size:9px;">Coach</span>';
          if (u.is_staff) roleBadges += '<span class="badge" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;font-size:9px;">Staff</span>';
          if (u.is_club_member) roleBadges += '<span class="badge" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff;font-size:9px;">Member</span>';
          if (!roleBadges) roleBadges = '-';
          
          return `
            <tr>
              <td><div class="avatar-small">${u.username?.[0]?.toUpperCase() || '?'}</div></td>
              <td><strong>@${u.username}</strong></td>
              <td>${u.display_name || '-'}</td>
              <td style="display:flex;gap:4px;flex-wrap:wrap;">${roleBadges}</td>
              <td style="font-size:12px;color:#888;">${new Date(u.since).toLocaleDateString()}</td>
              <td><button class="action-btn" style="background:rgba(16,185,129,0.2);color:#10b981;font-size:11px;padding:4px 8px;" onclick="showUserDetails(${u.id})">View</button></td>
            </tr>
          `;
        }).join('');
      } catch (err) {
        document.getElementById('followingTable').innerHTML = '<tr><td colspan="6" class="loading">Failed to load</td></tr>';
      }
    }
    
    async function loadFollowers(userId) {
      try {
        const data = await apiCall(`/admin/users/${userId}/social`);
        const table = document.getElementById('followersTable');
        
        if (data.followers.length === 0) {
          table.innerHTML = '<tr><td colspan="6" class="loading">No followers yet</td></tr>';
          return;
        }
        
        table.innerHTML = data.followers.map(u => {
          let roleBadges = '';
          if (u.is_admin) roleBadges += '<span class="badge badge-admin" style="font-size:9px;">Admin</span>';
          if (u.is_coach) roleBadges += '<span class="badge" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;font-size:9px;">Coach</span>';
          if (u.is_staff) roleBadges += '<span class="badge" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;font-size:9px;">Staff</span>';
          if (u.is_club_member) roleBadges += '<span class="badge" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff;font-size:9px;">Member</span>';
          if (!roleBadges) roleBadges = '-';
          
          return `
            <tr>
              <td><div class="avatar-small">${u.username?.[0]?.toUpperCase() || '?'}</div></td>
              <td><strong>@${u.username}</strong></td>
              <td>${u.display_name || '-'}</td>
              <td style="display:flex;gap:4px;flex-wrap:wrap;">${roleBadges}</td>
              <td style="font-size:12px;color:#888;">${new Date(u.since).toLocaleDateString()}</td>
              <td><button class="action-btn" style="background:rgba(16,185,129,0.2);color:#10b981;font-size:11px;padding:4px 8px;" onclick="showUserDetails(${u.id})">View</button></td>
            </tr>
          `;
        }).join('');
      } catch (err) {
        document.getElementById('followersTable').innerHTML = '<tr><td colspan="6" class="loading">Failed to load</td></tr>';
      }
    }
    
    async function deleteComment(type, commentId) {
      if (!confirm('Are you sure you want to delete this comment?')) return;
      try {
        await apiCall(`/admin/comments/${type}/${commentId}`, 'DELETE');
        showToast('Comment deleted');
        // Refresh current tab
        const activeTab = document.querySelector('.detail-tab.active').dataset.detailTab;
        switchDetailTab(activeTab);
      } catch (err) {
        showToast('Failed to delete comment: ' + err.message, 'error');
      }
    }
    
    async function restoreComment(type, commentId) {
      if (!confirm('Restore this comment?')) return;
      try {
        await apiCall(`/admin/comments/${type}/${commentId}/restore`, 'POST');
        showToast('Comment restored');
        // Refresh current tab
        const activeTab = document.querySelector('.detail-tab.active').dataset.detailTab;
        switchDetailTab(activeTab);
      } catch (err) {
        showToast('Failed to restore comment: ' + err.message, 'error');
      }
    }

    // Show user sales history
    async function showUserSales(userId, username) {
      try {
        const orders = await apiCall(`/admin/users/${userId}/orders`);
        const content = orders.length === 0 
          ? '<p style="color:#888;text-align:center;padding:20px;">No purchases found</p>'
          : `<table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="border-bottom:1px solid #333;">
                  <th style="text-align:left;padding:8px;color:#888;font-size:12px;">Order ID</th>
                  <th style="text-align:left;padding:8px;color:#888;font-size:12px;">Product</th>
                  <th style="text-align:right;padding:8px;color:#888;font-size:12px;">Amount</th>
                  <th style="text-align:left;padding:8px;color:#888;font-size:12px;">Date</th>
                  <th style="text-align:left;padding:8px;color:#888;font-size:12px;">Status</th>
                </tr>
              </thead>
              <tbody>
                ${orders.map(o => `
                  <tr style="border-bottom:1px solid #222;">
                    <td style="padding:8px;"><code style="color:#a78bfa;">${o.public_id}</code></td>
                    <td style="padding:8px;color:#fff;">${o.product_name}</td>
                    <td style="padding:8px;text-align:right;color:#22c55e;">‚Ç¨${parseFloat(o.amount).toFixed(2)}</td>
                    <td style="padding:8px;color:#888;font-size:12px;">${new Date(o.created_at).toLocaleDateString()}</td>
                    <td style="padding:8px;"><span class="badge" style="font-size:10px;">${o.status}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>`;
        
        showUserModal('Sales History', username, content, 'üì¶');
      } catch (err) {
        alert('Failed to load sales: ' + err.message);
      }
    }

    // Show user events
    async function showUserEvents(userId, username) {
      try {
        const events = await apiCall(`/admin/users/${userId}/events`);
        const content = events.length === 0 
          ? '<p style="color:#888;text-align:center;padding:20px;">No event registrations found</p>'
          : `<table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="border-bottom:1px solid #333;">
                  <th style="text-align:left;padding:8px;color:#888;font-size:12px;">Event</th>
                  <th style="text-align:left;padding:8px;color:#888;font-size:12px;">Date</th>
                  <th style="text-align:left;padding:8px;color:#888;font-size:12px;">Location</th>
                  <th style="text-align:left;padding:8px;color:#888;font-size:12px;">Registered</th>
                </tr>
              </thead>
              <tbody>
                ${events.map(e => `
                  <tr style="border-bottom:1px solid #222;">
                    <td style="padding:8px;color:#fff;">${e.title}</td>
                    <td style="padding:8px;color:#3b82f6;">${e.date ? new Date(e.date).toLocaleDateString() : '-'}${e.time ? ' ' + e.time : ''}</td>
                    <td style="padding:8px;color:#888;font-size:12px;">${e.location || '-'}</td>
                    <td style="padding:8px;color:#888;font-size:12px;">${e.registered_at ? new Date(e.registered_at).toLocaleDateString() : '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>`;
        
        showUserModal('Event Registrations', username, content, 'üìÖ');
      } catch (err) {
        alert('Failed to load events: ' + err.message);
      }
    }

    // Show user login logs
    async function showUserLogs(userId, username) {
      try {
        const logs = await apiCall(`/admin/users/${userId}/logins`);
        const content = logs.length === 0 
          ? '<p style="color:#888;text-align:center;padding:20px;">No login history found</p>'
          : `<table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="border-bottom:1px solid #333;">
                  <th style="text-align:left;padding:8px;color:#888;font-size:12px;">Date & Time</th>
                  <th style="text-align:left;padding:8px;color:#888;font-size:12px;">IP Address</th>
                  <th style="text-align:left;padding:8px;color:#888;font-size:12px;">Device</th>
                  <th style="text-align:left;padding:8px;color:#888;font-size:12px;">Status</th>
                </tr>
              </thead>
              <tbody>
                ${logs.map(l => {
                  const statusBadge = l.success 
                    ? '<span class="badge" style="background:rgba(34,197,94,0.2);color:#22c55e;font-size:10px;">Success</span>'
                    : '<span class="badge" style="background:rgba(239,68,68,0.2);color:#ef4444;font-size:10px;">Failed</span>';
                  const device = l.user_agent ? (l.user_agent.includes('Mobile') ? 'üì± Mobile' : 'üíª Desktop') : '-';
                  return `
                  <tr style="border-bottom:1px solid #222;">
                    <td style="padding:8px;color:#fff;font-size:12px;">${new Date(l.login_time).toLocaleString()}</td>
                    <td style="padding:8px;color:#888;font-size:12px;font-family:monospace;">${l.ip_address || '-'}</td>
                    <td style="padding:8px;color:#888;font-size:12px;">${device}</td>
                    <td style="padding:8px;">${statusBadge}</td>
                  </tr>
                `}).join('')}
              </tbody>
            </table>`;
        
        showUserModal('Login History', username, content, 'üîê');
      } catch (err) {
        alert('Failed to load logs: ' + err.message);
      }
    }

    // Show user's RFID bands
    async function showUserBands(userId, username) {
      try {
        document.getElementById('bandsUserId').value = userId;
        document.getElementById('bandsUsername').textContent = username;
        document.getElementById('bandsList').innerHTML = '<p style="color:#888;text-align:center;">Loading...</p>';
        document.getElementById('bandsModal').classList.add('active');
        
        const response = await apiCall(`/admin/rfid/user/${userId}`);
        const bands = response.bands || [];
        
        if (bands.length === 0) {
          document.getElementById('bandsList').innerHTML = `
            <div style="text-align:center;padding:40px;color:#888;">
              <p style="font-size:48px;margin-bottom:16px;">üè∑Ô∏è</p>
              <p>No wristbands linked to this account</p>
              <p style="font-size:12px;margin-top:8px;color:#666;">User can link a band at the kiosk</p>
            </div>
          `;
          return;
        }
        
        document.getElementById('bandsList').innerHTML = `
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:1px solid #333;">
                <th style="padding:10px;text-align:left;color:#888;font-size:11px;text-transform:uppercase;">Band UID</th>
                <th style="padding:10px;text-align:left;color:#888;font-size:11px;text-transform:uppercase;">Assigned</th>
                <th style="padding:10px;text-align:center;color:#888;font-size:11px;text-transform:uppercase;">Status</th>
                <th style="padding:10px;text-align:right;color:#888;font-size:11px;text-transform:uppercase;">Action</th>
              </tr>
            </thead>
            <tbody>
              ${bands.map(b => {
                const assignedDate = new Date(b.assigned_at);
                const formattedDate = assignedDate.toLocaleDateString() + ' ' + assignedDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const statusBadge = b.is_active 
                  ? '<span style="padding:4px 8px;border-radius:8px;background:rgba(34,197,94,0.2);color:#22c55e;font-size:11px;">Active</span>'
                  : '<span style="padding:4px 8px;border-radius:8px;background:rgba(239,68,68,0.2);color:#ef4444;font-size:11px;">Inactive</span>';
                const removeBtn = b.is_active 
                  ? `<button onclick="removeBand(${b.id}, '${b.band_uid.substring(0,12)}...')" style="padding:4px 8px;border-radius:6px;background:rgba(239,68,68,0.2);color:#ef4444;border:none;font-size:11px;cursor:pointer;">Remove</button>`
                  : '-';
                return `
                  <tr style="border-bottom:1px solid #222;">
                    <td style="padding:10px;color:#fff;font-size:12px;font-family:monospace;">${b.band_uid.length > 20 ? b.band_uid.substring(0, 20) + '...' : b.band_uid}</td>
                    <td style="padding:10px;color:#888;font-size:12px;">${formattedDate}</td>
                    <td style="padding:10px;text-align:center;">${statusBadge}</td>
                    <td style="padding:10px;text-align:right;">${removeBtn}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          <p style="margin-top:16px;font-size:12px;color:#666;text-align:center;">
            Total: ${bands.filter(b => b.is_active).length} active / ${bands.length} total bands
          </p>
        `;
      } catch (err) {
        document.getElementById('bandsList').innerHTML = `<p style="color:#ef4444;text-align:center;">Failed to load bands: ${err.message}</p>`;
      }
    }

    // Remove RFID band (admin)
    async function removeBand(bandId, bandUidPreview) {
      if (!confirm(`Remove wristband ${bandUidPreview} from this user?`)) return;
      try {
        await apiCall(`/admin/rfid/${bandId}`, 'DELETE');
        const userId = document.getElementById('bandsUserId').value;
        const username = document.getElementById('bandsUsername').textContent;
        showUserBands(userId, username); // Refresh list
        alert('Wristband removed successfully');
      } catch (err) {
        alert('Failed to remove band: ' + err.message);
      }
    }

    // Generic user details modal
    function showUserModal(title, username, content, emoji = 'üë§') {
      // Remove existing modal if any
      const existingModal = document.getElementById('userDetailsModal');
      if (existingModal) existingModal.remove();
      
      const modal = document.createElement('div');
      modal.id = 'userDetailsModal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      
      modal.innerHTML = `
        <div style="background:#1a1a2e;border:1px solid #333;border-radius:16px;max-width:700px;width:100%;max-height:90vh;overflow:auto;">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #333;">
            <h3 style="margin:0;color:#fff;">${emoji} ${title} - ${username}</h3>
            <button onclick="this.closest('#userDetailsModal').remove()" style="background:none;border:none;color:#888;font-size:24px;cursor:pointer;">&times;</button>
          </div>
          <div style="padding:20px;max-height:60vh;overflow:auto;">${content}</div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function openUserModal(user = null) {
      document.getElementById('userModalTitle').textContent = user ? 'Edit User' : 'Add User';
      document.getElementById('userId').value = user?.id || '';
      document.getElementById('userUsername').value = user?.username || '';
      document.getElementById('userEmail').value = user?.email || '';
      document.getElementById('userPassword').value = '';
      document.getElementById('userIsAdmin').checked = user?.is_admin || false;
      document.getElementById('userIsCoach').checked = user?.is_coach || false;
      document.getElementById('userIsStaff').checked = user?.is_staff || false;
      document.getElementById('userIsClubMember').checked = user?.is_club_member || false;
      document.getElementById('userModal').classList.add('active');
    }

    async function editUser(id) {
      try {
        const users = await apiCall('/admin/users');
        const user = users.find(u => u.id === id);
        if (user) openUserModal(user);
      } catch (err) {
        alert('Failed to load user');
      }
    }

    async function saveUser() {
      const id = document.getElementById('userId').value;
      const data = {
        username: document.getElementById('userUsername').value,
        email: document.getElementById('userEmail').value,
        is_admin: document.getElementById('userIsAdmin').checked,
        is_coach: document.getElementById('userIsCoach').checked,
        is_staff: document.getElementById('userIsStaff').checked,
        is_club_member: document.getElementById('userIsClubMember').checked
      };
      const password = document.getElementById('userPassword').value;
      if (password) data.password = password;
      
      try {
        if (id) {
          // PUT now saves roles too
          await apiCall(`/admin/users/${id}`, 'PUT', data);
        } else {
          await apiCall('/admin/users', 'POST', data);
        }
        closeModal('userModal');
        loadUsers();
        showToast('User saved successfully!');
      } catch (err) {
        alert('Failed to save user: ' + err.message);
      }
    }

    async function deleteUser(id) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      try {
        await apiCall(`/admin/users/${id}`, 'DELETE');
        loadUsers();
      } catch (err) {
        alert('Failed to delete user: ' + err.message);
      }
    }

    // ============ TRICKS ============
    
    async function loadTricks() {
      try {
        const tricks = await apiCall('/tricks');
        tricks.sort((a, b) => (a.position || 0) - (b.position || 0));
        document.getElementById('tricksTable').innerHTML = tricks.map(t => `
          <tr>
            <td><code class="public-id">${t.public_id || '-'}</code></td>
            <td>${t.image_url ? `<img src="${t.image_url}" style="width:28px;height:28px;border-radius:4px;object-fit:cover;vertical-align:middle;margin-right:8px" onerror="this.style.display='none'">` : ''}${t.name}</td>
            <td>${t.category}</td>
            <td>${t.difficulty}</td>
            <td style="text-align:center;color:#999">${t.position || 0}</td>
            <td>${(t.description || '-').substring(0, 50)}...</td>
            <td class="actions">
              <button class="action-btn edit-btn" onclick="editTrick(${t.id})">Edit</button>
              <button class="action-btn delete-btn" onclick="deleteTrick(${t.id})">Delete</button>
            </td>
          </tr>
        `).join('') || '<tr><td colspan="7" class="loading">No tricks found</td></tr>';
      } catch (err) {
        document.getElementById('tricksTable').innerHTML = '<tr><td colspan="7" class="loading">Failed to load tricks</td></tr>';
      }
    }

    const DEFAULT_SECTION_NAMES = [
      'Intro', 'Approach', 'Edge', 'Pop', 'Lock', 
      'Drop', 'Add some spice!', 'Common mistakes', 'How improve myself', 'Next tricks to Learn'
    ];

    function buildSectionsEditor(sections) {
      const container = document.getElementById('trickSectionsContainer');
      container.innerHTML = '';
      
      for (let i = 0; i < 10; i++) {
        const section = sections[i] || { title: DEFAULT_SECTION_NAMES[i], content: '' };
        const div = document.createElement('div');
        div.style.cssText = 'margin-bottom:8px;border:1px solid rgba(139,92,246,0.2);border-radius:8px;overflow:hidden;';
        
        const header = document.createElement('div');
        header.style.cssText = 'display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(139,92,246,0.08);cursor:pointer;';
        header.innerHTML = `
          <span style="color:#999;font-size:12px;min-width:20px">${i+1}.</span>
          <input type="text" id="sectionTitle_${i}" value="${(section.title || DEFAULT_SECTION_NAMES[i]).replace(/"/g, '&quot;')}" 
            placeholder="${DEFAULT_SECTION_NAMES[i]}" 
            style="flex:1;background:transparent;border:none;color:#e0e0e0;font-size:13px;font-weight:600;outline:none" 
            onclick="event.stopPropagation()">
          <span class="section-toggle" style="color:#999;font-size:14px;transition:transform 0.2s">‚ñº</span>
        `;
        header.addEventListener('click', (e) => {
          if (e.target.tagName === 'INPUT') return;
          const body = div.querySelector('.section-body');
          const toggle = header.querySelector('.section-toggle');
          if (body.style.display === 'none') {
            body.style.display = 'block';
            toggle.style.transform = 'rotate(180deg)';
          } else {
            body.style.display = 'none';
            toggle.style.transform = 'rotate(0deg)';
          }
        });
        
        const body = document.createElement('div');
        body.className = 'section-body';
        body.style.cssText = `display:${section.content ? 'block' : 'none'};padding:8px 12px;`;
        body.innerHTML = `
          <div class="rich-toolbar" style="margin-bottom:4px">
            <button type="button" onclick="insertBullet('sectionContent_${i}')">‚Ä¢ Bullet</button>
            <button type="button" onclick="insertLink('sectionContent_${i}')">üîó Link</button>
          </div>
          <textarea id="sectionContent_${i}" rows="4" placeholder="Content for this section..." 
            style="width:100%;background:#1a1a2e;border:1px solid rgba(139,92,246,0.2);border-radius:6px;color:#e0e0e0;padding:8px;font-size:13px;resize:vertical">${section.content || ''}</textarea>
        `;
        
        if (section.content) {
          header.querySelector('.section-toggle').style.transform = 'rotate(180deg)';
        }
        
        div.appendChild(header);
        div.appendChild(body);
        container.appendChild(div);
      }
    }

    function collectSections() {
      const sections = [];
      for (let i = 0; i < 10; i++) {
        const title = document.getElementById(`sectionTitle_${i}`)?.value || DEFAULT_SECTION_NAMES[i];
        const content = document.getElementById(`sectionContent_${i}`)?.value || '';
        sections.push({ title, content });
      }
      return sections;
    }

    function openTrickModal(trick = null) {
      document.getElementById('trickModalTitle').textContent = trick ? 'Edit Trick' : 'Add Trick';
      document.getElementById('trickId').value = trick?.id || '';
      document.getElementById('trickName').value = trick?.name || '';
      document.getElementById('trickCategory').value = trick?.category || 'surface';
      document.getElementById('trickDifficulty').value = trick?.difficulty || 'beginner';
      document.getElementById('trickDescription').value = trick?.description || '';
      document.getElementById('trickPosition').value = trick?.position || 0;
      document.getElementById('trickVideoUrl').value = trick?.video_url || '';
      document.getElementById('trickImageUrl').value = trick?.image_url || '';
      showImagePreview('trickImageUrl', 'trickImagePreview');
      
      // Build sections editor
      let sections = [];
      if (trick?.sections) {
        sections = typeof trick.sections === 'string' ? JSON.parse(trick.sections) : trick.sections;
      }
      buildSectionsEditor(sections);
      
      document.getElementById('trickModal').classList.add('active');
    }

    async function editTrick(id) {
      try {
        const tricks = await apiCall('/tricks');
        const trick = tricks.find(t => t.id === id);
        if (trick) openTrickModal(trick);
      } catch (err) {
        alert('Failed to load trick');
      }
    }

    async function saveTrick() {
      const id = document.getElementById('trickId').value;
      const data = {
        name: document.getElementById('trickName').value,
        category: document.getElementById('trickCategory').value,
        difficulty: document.getElementById('trickDifficulty').value,
        description: document.getElementById('trickDescription').value,
        full_description: '',
        video_url: document.getElementById('trickVideoUrl').value,
        image_url: document.getElementById('trickImageUrl').value,
        sections: collectSections(),
        position: parseFloat(document.getElementById('trickPosition').value) || 0
      };
      
      try {
        if (id) {
          await apiCall(`/admin/tricks/${id}`, 'PUT', data);
        } else {
          await apiCall('/admin/tricks', 'POST', data);
        }
        closeModal('trickModal');
        loadTricks();
      } catch (err) {
        alert('Failed to save trick: ' + err.message);
      }
    }

    async function deleteTrick(id) {
      if (!confirm('Are you sure you want to delete this trick?')) return;
      try {
        await apiCall(`/admin/tricks/${id}`, 'DELETE');
        loadTricks();
      } catch (err) {
        alert('Failed to delete trick: ' + err.message);
      }
    }

    // ============ EVENTS ============
    
    async function loadEvents() {
      try {
        const events = await apiCall('/admin/events');
        document.getElementById('eventsTable').innerHTML = events.map(e => `
          <tr>
            <td><code class="public-id">${e.public_id || '-'}</code></td>
            <td>${e.name}</td>
            <td>${e.date}</td>
            <td>${e.time}</td>
            <td>${e.location}</td>
            <td>${e.attendees || 0}/${e.spots}</td>
            <td>
              <div style="display:flex;align-items:center;gap:8px;">
                <div class="avatar-small">${e.author_username?.[0]?.toUpperCase() || '?'}</div>
                <span>${e.author_username || 'System'}</span>
              </div>
            </td>
            <td class="actions">
              <button class="action-btn edit-btn" onclick="editEvent(${e.id})">Edit</button>
              <button class="action-btn delete-btn" onclick="deleteEvent(${e.id})">Delete</button>
            </td>
          </tr>
        `).join('') || '<tr><td colspan="8" class="loading">No events found</td></tr>';
      } catch (err) {
        document.getElementById('eventsTable').innerHTML = '<tr><td colspan="8" class="loading">Failed to load events</td></tr>';
      }
    }

    function openEventModal(event = null) {
      document.getElementById('eventModalTitle').textContent = event ? 'Edit Event' : 'Add Event';
      document.getElementById('eventId').value = event?.id || '';
      document.getElementById('eventName').value = event?.name || '';
      document.getElementById('eventDate').value = event?.date || '';
      document.getElementById('eventTime').value = event?.time || '';
      document.getElementById('eventLocation').value = event?.location || '';
      document.getElementById('eventLocationUrl').value = event?.location_url || '';
      document.getElementById('eventSpots').value = event?.spots || 10;
      document.getElementById('eventModal').classList.add('active');
    }

    async function editEvent(id) {
      try {
        const events = await apiCall('/admin/events');
        const event = events.find(e => e.id === id);
        if (event) openEventModal(event);
      } catch (err) {
        alert('Failed to load event');
      }
    }

    async function saveEvent() {
      const id = document.getElementById('eventId').value;
      const data = {
        name: document.getElementById('eventName').value,
        date: document.getElementById('eventDate').value,
        time: document.getElementById('eventTime').value,
        location: document.getElementById('eventLocation').value,
        location_url: document.getElementById('eventLocationUrl').value,
        spots: parseInt(document.getElementById('eventSpots').value) || 10
      };
      
      try {
        if (id) {
          await apiCall(`/admin/events/${id}`, 'PUT', data);
        } else {
          await apiCall('/admin/events', 'POST', data);
        }
        closeModal('eventModal');
        loadEvents();
      } catch (err) {
        alert('Failed to save event: ' + err.message);
      }
    }

    async function deleteEvent(id) {
      if (!confirm('Are you sure you want to delete this event?')) return;
      try {
        await apiCall(`/admin/events/${id}`, 'DELETE');
        loadEvents();
      } catch (err) {
        alert('Failed to delete event: ' + err.message);
      }
    }

    // ============ NEWS ============
    
    async function loadNews() {
      try {
        const news = await apiCall('/admin/news');
        document.getElementById('newsTable').innerHTML = news.map(n => {
          const readCount = parseInt(n.read_count) || 0;
          const totalUsers = parseInt(n.total_users) || 0;
          const readPercent = totalUsers > 0 ? Math.round((readCount / totalUsers) * 100) : 0;
          const readColor = readPercent >= 50 ? '#22c55e' : readPercent >= 20 ? '#f59e0b' : '#ef4444';
          
          return `
          <tr>
            <td><code class="public-id">${n.public_id || '-'}</code></td>
            <td>${n.emoji || ''} ${n.title}</td>
            <td>${n.type}</td>
            <td>${(n.message || '-').substring(0, 40)}...</td>
            <td>
              <span class="read-stats" onclick="showNewsReads(${n.id}, '${n.title.replace(/'/g, "\\'")}')" style="cursor: pointer; display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; background: rgba(255,255,255,0.05); border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                <span style="color: ${readColor}; font-weight: 600;">${readCount}</span>
                <span style="color: rgba(255,255,255,0.4);">/</span>
                <span style="color: rgba(255,255,255,0.6);">${totalUsers}</span>
                <span style="color: rgba(255,255,255,0.4); font-size: 11px;">(${readPercent}%)</span>
              </span>
            </td>
            <td>${n.created_at ? new Date(n.created_at).toLocaleDateString() : '-'}</td>
            <td class="actions">
              <button class="action-btn edit-btn" onclick="editNews(${n.id})">Edit</button>
              <button class="action-btn delete-btn" onclick="deleteNews(${n.id})">Delete</button>
            </td>
          </tr>
        `}).join('') || '<tr><td colspan="7" class="loading">No news found</td></tr>';
      } catch (err) {
        document.getElementById('newsTable').innerHTML = '<tr><td colspan="7" class="loading">Failed to load news</td></tr>';
      }
    }

    function openNewsModal(news = null) {
      document.getElementById('newsModalTitle').textContent = news ? 'Edit News' : 'Add News';
      document.getElementById('newsId').value = news?.id || '';
      document.getElementById('newsTitle').value = news?.title || '';
      document.getElementById('newsType').value = news?.type || 'info';
      document.getElementById('newsEmoji').value = news?.emoji || '';
      document.getElementById('newsMessage').value = news?.message || '';
      
      // Clear emoji selection and re-select if editing
      document.querySelectorAll('.emoji-btn').forEach(btn => btn.classList.remove('selected'));
      if (news?.emoji) {
        document.querySelectorAll('.emoji-btn').forEach(btn => {
          if (btn.textContent === news.emoji) btn.classList.add('selected');
        });
      }
      
      document.getElementById('newsModal').classList.add('active');
    }

    function selectEmoji(emoji) {
      document.getElementById('newsEmoji').value = emoji;
      document.querySelectorAll('.emoji-btn').forEach(btn => btn.classList.remove('selected'));
      event.target.classList.add('selected');
    }

    async function editNews(id) {
      try {
        const news = await apiCall('/admin/news');
        const item = news.find(n => n.id === id);
        if (item) openNewsModal(item);
      } catch (err) {
        alert('Failed to load news');
      }
    }

    async function saveNews() {
      const id = document.getElementById('newsId').value;
      const data = {
        title: document.getElementById('newsTitle').value,
        type: document.getElementById('newsType').value,
        emoji: document.getElementById('newsEmoji').value,
        message: document.getElementById('newsMessage').value
      };
      
      try {
        if (id) {
          await apiCall(`/admin/news/${id}`, 'PUT', data);
        } else {
          await apiCall('/admin/news', 'POST', data);
        }
        closeModal('newsModal');
        loadNews();
      } catch (err) {
        alert('Failed to save news: ' + err.message);
      }
    }

    async function deleteNews(id) {
      if (!confirm('Are you sure you want to delete this news?')) return;
      try {
        await apiCall(`/admin/news/${id}`, 'DELETE');
        loadNews();
      } catch (err) {
        alert('Failed to delete news: ' + err.message);
      }
    }

    // Show who read a specific news
    async function showNewsReads(newsId, newsTitle) {
      try {
        const readers = await apiCall(`/admin/news/${newsId}/reads`);
        
        const modalHtml = `
          <div class="modal active" id="newsReadsModal" onclick="if(event.target === this) closeModal('newsReadsModal')">
            <div class="modal-content" style="max-width: 600px;">
              <div class="modal-header">
                <h3>üìñ Who read this news</h3>
                <button class="close-btn" onclick="closeModal('newsReadsModal')">√ó</button>
              </div>
              <div class="modal-body">
                <p style="margin-bottom: 16px; color: rgba(255,255,255,0.7);">
                  <strong>${newsTitle}</strong><br>
                  <span style="font-size: 13px;">${readers.length} user${readers.length !== 1 ? 's' : ''} read this news</span>
                </p>
                ${readers.length > 0 ? `
                  <div style="max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%;">
                      <thead>
                        <tr>
                          <th>User</th>
                          <th>Read at</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${readers.map(r => `
                          <tr>
                            <td>
                              <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="avatar-small">${(r.display_name || r.username)?.[0]?.toUpperCase() || '?'}</div>
                                <div>
                                  <div style="font-weight: 500;">${r.display_name || r.username}</div>
                                  <div style="font-size: 11px; color: rgba(255,255,255,0.4);">@${r.username}</div>
                                </div>
                              </div>
                            </td>
                            <td style="color: rgba(255,255,255,0.6);">
                              ${r.read_at ? new Date(r.read_at).toLocaleString() : '-'}
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                ` : `
                  <p style="text-align: center; color: rgba(255,255,255,0.4); padding: 40px;">
                    No one has read this news yet
                  </p>
                `}
              </div>
            </div>
          </div>
        `;
        
        // Remove existing modal if any
        const existing = document.getElementById('newsReadsModal');
        if (existing) existing.remove();
        
        // Add new modal
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
      } catch (err) {
        alert('Failed to load readers: ' + err.message);
      }
    }

    // ============ ARTICLES ============
    
    async function loadArticles() {
      try {
        const articles = await apiCall('/articles');
        document.getElementById('articlesTable').innerHTML = articles.map(a => `
          <tr>
            <td><code class="public-id">${a.public_id || '-'}</code></td>
            <td>${a.image_url ? `<img src="${a.image_url}" style="width:28px;height:28px;border-radius:4px;object-fit:cover;vertical-align:middle;margin-right:8px" onerror="this.style.display='none'">` : ''}${a.title}</td>
            <td><span class="badge badge-user">${a.category}</span></td>
            <td>${(a.description || '-').substring(0, 40)}...</td>
            <td>${a.read_time || '-'}</td>
            <td>
              <div style="display:flex;align-items:center;gap:8px;">
                <div class="avatar-small">${a.author_username?.[0]?.toUpperCase() || '?'}</div>
                <span>${a.author_username || 'System'}</span>
              </div>
            </td>
            <td class="actions">
              <button class="action-btn edit-btn" onclick="editArticle(${a.id})">Edit</button>
              <button class="action-btn delete-btn" onclick="deleteArticle(${a.id})">Delete</button>
            </td>
          </tr>
        `).join('') || '<tr><td colspan="7" class="loading">No articles found</td></tr>';
      } catch (err) {
        document.getElementById('articlesTable').innerHTML = '<tr><td colspan="7" class="loading">Failed to load articles</td></tr>';
      }
    }

    function openArticleModal(article = null) {
      document.getElementById('articleModalTitle').textContent = article ? 'Edit Article' : 'Add Article';
      document.getElementById('articleId').value = article?.id || '';
      document.getElementById('articleTitle').value = article?.title || '';
      document.getElementById('articleCategory').value = article?.category || 'balance';
      document.getElementById('articleDescription').value = article?.description || '';
      document.getElementById('articleContent').value = article?.content || '';
      document.getElementById('articleReadTime').value = article?.read_time || '5 min';
      document.getElementById('articleImageUrl').value = article?.image_url || '';
      showImagePreview('articleImageUrl', 'articleImagePreview');
      document.getElementById('articleModal').classList.add('active');
    }

    async function editArticle(id) {
      try {
        const articles = await apiCall('/articles');
        const article = articles.find(a => a.id === id);
        if (article) openArticleModal(article);
      } catch (err) {
        alert('Failed to load article');
      }
    }

    async function saveArticle() {
      const id = document.getElementById('articleId').value;
      const data = {
        title: document.getElementById('articleTitle').value,
        category: document.getElementById('articleCategory').value,
        description: document.getElementById('articleDescription').value,
        content: document.getElementById('articleContent').value,
        read_time: document.getElementById('articleReadTime').value,
        image_url: document.getElementById('articleImageUrl').value
      };
      
      try {
        if (id) {
          await apiCall(`/admin/articles/${id}`, 'PUT', data);
        } else {
          await apiCall('/admin/articles', 'POST', data);
        }
        closeModal('articleModal');
        loadArticles();
      } catch (err) {
        alert('Failed to save article: ' + err.message);
      }
    }

    async function deleteArticle(id) {
      if (!confirm('Are you sure you want to delete this article?')) return;
      try {
        await apiCall(`/admin/articles/${id}`, 'DELETE');
        loadArticles();
      } catch (err) {
        alert('Failed to delete article: ' + err.message);
      }
    }

    // ============ PRODUCTS ============
    
    async function loadProducts() {
      try {
        const products = await apiCall('/admin/products');
        document.getElementById('productsTable').innerHTML = products.map(p => `
          <tr>
            <td><code class="public-id">${p.public_id || '-'}</code></td>
            <td>${p.icon || ''} ${p.name}</td>
            <td><span class="badge" style="background: ${p.category === 'cable' ? 'rgba(59,130,246,0.3)' : p.category === 'activities' ? 'rgba(251,191,36,0.3)' : p.category === 'events' ? 'rgba(236,72,153,0.3)' : 'rgba(139,92,246,0.3)'}">${p.category}</span></td>
            <td>‚Ç¨${parseFloat(p.price).toFixed(2)}</td>
            <td>${p.duration || '-'}</td>
            <td><span class="badge ${p.is_active ? 'badge-success' : 'badge-warning'}">${p.is_active ? 'Active' : 'Inactive'}</span></td>
            <td class="actions">
              <button class="action-btn edit-btn" onclick="editProduct(${p.id})">Edit</button>
              <button class="action-btn delete-btn" onclick="deleteProduct(${p.id})">Delete</button>
            </td>
          </tr>
        `).join('') || '<tr><td colspan="7" class="loading">No products found</td></tr>';
      } catch (err) {
        document.getElementById('productsTable').innerHTML = '<tr><td colspan="7" class="loading">Failed to load products. Run migration: /api/run-products-migration?key=lunar2025</td></tr>';
      }
    }

    function openProductModal(product = null) {
      document.getElementById('productModalTitle').textContent = product ? 'Edit Product' : 'Add Product';
      document.getElementById('productId').value = product?.id || '';
      document.getElementById('productName').value = product?.name || '';
      document.getElementById('productCategory').value = product?.category || 'cable';
      document.getElementById('productPrice').value = product?.price || '';
      document.getElementById('productDuration').value = product?.duration || '';
      document.getElementById('productDescription').value = product?.description || '';
      document.getElementById('productIcon').value = product?.icon || '';
      document.getElementById('productActive').checked = product?.is_active !== false;
      document.getElementById('productModal').classList.add('active');
    }

    async function editProduct(id) {
      try {
        const products = await apiCall('/admin/products');
        const product = products.find(p => p.id === id);
        if (product) openProductModal(product);
      } catch (err) {
        alert('Failed to load product');
      }
    }

    async function saveProduct() {
      const id = document.getElementById('productId').value;
      const data = {
        name: document.getElementById('productName').value,
        category: document.getElementById('productCategory').value,
        price: parseFloat(document.getElementById('productPrice').value),
        duration: document.getElementById('productDuration').value || null,
        description: document.getElementById('productDescription').value,
        icon: document.getElementById('productIcon').value,
        is_active: document.getElementById('productActive').checked
      };
      
      try {
        if (id) {
          await apiCall(`/admin/products/${id}`, 'PUT', data);
        } else {
          await apiCall('/admin/products', 'POST', data);
        }
        closeModal('productModal');
        loadProducts();
      } catch (err) {
        alert('Failed to save product: ' + err.message);
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      try {
        await apiCall(`/admin/products/${id}`, 'DELETE');
        loadProducts();
      } catch (err) {
        alert('Failed to delete product: ' + err.message);
      }
    }

    // ============ ACHIEVEMENTS ============

    const tierColors = {
      bronze: { bg: 'rgba(205,127,50,0.2)', border: 'rgba(205,127,50,0.4)', text: '#CD7F32' },
      silver: { bg: 'rgba(192,192,192,0.2)', border: 'rgba(192,192,192,0.4)', text: '#C0C0C0' },
      gold: { bg: 'rgba(255,215,0,0.2)', border: 'rgba(255,215,0,0.4)', text: '#FFD700' },
      platinum: { bg: 'rgba(0,206,209,0.2)', border: 'rgba(0,206,209,0.4)', text: '#00CED1' },
      special: { bg: 'rgba(0,206,209,0.2)', border: 'rgba(0,206,209,0.4)', text: '#00CED1' }
    };

    const tierLabels = { bronze: 'BRONZE', silver: 'SILVER', gold: 'GOLD', platinum: 'PLATINUM', special: 'SPECIAL' };

    async function loadAchievementsStats() {
      try {
        const stats = await apiCall('/admin/achievements/stats');
        
        // Render automatic achievements
        const autoAchievements = stats.filter(a => a.type === 'automatic');
        document.getElementById('autoAchievementsGrid').innerHTML = autoAchievements.map(a => `
          <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <span style="font-size: 32px;">${a.icon}</span>
              <div>
                <h4 style="color: #fff; font-size: 15px; margin-bottom: 4px;">${a.name}</h4>
                <p style="color: rgba(255,255,255,0.5); font-size: 12px;">${a.description}</p>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
              ${['bronze', 'silver', 'gold', 'platinum'].map(tier => {
                const count = a.tiers?.[tier] || 0;
                const tc = tierColors[tier];
                return `
                  <div style="text-align: center; padding: 8px; background: ${tc.bg}; border: 1px solid ${tc.border}; border-radius: 8px;">
                    <div style="font-size: 18px; font-weight: 700; color: ${tc.text};">${count}</div>
                    <div style="font-size: 9px; color: ${tc.text}; font-weight: 600;">${tierLabels[tier]}</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `).join('') || '<p style="color: rgba(255,255,255,0.5);">No automatic achievements found</p>';
        
        // Render manual achievements
        const manualAchievements = stats.filter(a => a.type === 'manual');
        document.getElementById('manualAchievementsGrid').innerHTML = manualAchievements.map(a => {
          const tc = tierColors.special;
          const count = a.tiers?.special || 0;
          return `
            <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(0,206,209,0.2); border-radius: 16px; padding: 20px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="font-size: 32px;">${a.icon}</span>
                <div style="flex: 1;">
                  <h4 style="color: #fff; font-size: 15px; margin-bottom: 4px;">${a.name}</h4>
                  <p style="color: rgba(255,255,255,0.5); font-size: 12px;">${a.description}</p>
                </div>
                <div style="text-align: center; padding: 12px 16px; background: ${tc.bg}; border: 1px solid ${tc.border}; border-radius: 10px;">
                  <div style="font-size: 24px; font-weight: 700; color: ${tc.text};">${count}</div>
                  <div style="font-size: 10px; color: ${tc.text};">AWARDED</div>
                </div>
              </div>
            </div>
          `;
        }).join('') || '<p style="color: rgba(255,255,255,0.5);">No manual achievements found</p>';
        
      } catch (err) {
        console.error('Failed to load achievements stats:', err);
        document.getElementById('autoAchievementsGrid').innerHTML = '<p style="color: #f43f5e;">Failed to load achievements</p>';
        document.getElementById('manualAchievementsGrid').innerHTML = '';
      }
    }

    // Grant manual achievement to user
    async function grantAchievement(userId, achievementId, note = '') {
      await apiCall(`/admin/users/${userId}/grant-achievement`, 'POST', { achievement_id: achievementId, note });
    }

    // Revoke manual achievement
    async function revokeAchievement(userId, achievementId) {
      if (!confirm('Revoke this achievement from the user?')) return;
      try {
        await apiCall(`/admin/users/${userId}/revoke-achievement/${achievementId}`, 'DELETE');
        showToast('Achievement revoked');
        loadUserManualAchievements(userId);
      } catch (err) {
        alert('Failed to revoke achievement: ' + err.message);
      }
    }

    // Load user's manual achievements (for user detail modal)
    async function loadUserManualAchievements(userId) {
      try {
        const achievements = await apiCall(`/admin/users/${userId}/manual-achievements`);
        const container = document.getElementById('userManualAchievements');
        if (!container) return;
        
        container.innerHTML = achievements.length > 0 
          ? achievements.map(a => `
              <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(0,206,209,0.1); border: 1px solid rgba(0,206,209,0.2); border-radius: 10px; margin-bottom: 8px;">
                <span style="font-size: 24px;">${a.icon}</span>
                <div style="flex: 1;">
                  <div style="font-size: 13px; font-weight: 600; color: #fff;">${a.name}</div>
                  <div style="font-size: 11px; color: rgba(255,255,255,0.5);">Awarded: ${new Date(a.awarded_at).toLocaleDateString()}</div>
                  ${a.note ? `<div style="font-size: 11px; color: rgba(255,255,255,0.4); font-style: italic;">"${a.note}"</div>` : ''}
                </div>
                <button onclick="revokeAchievement(${userId}, '${a.id}')" style="padding: 6px 10px; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); border-radius: 6px; color: #f87171; font-size: 11px; cursor: pointer;">Revoke</button>
              </div>
            `).join('')
          : '<p style="color: rgba(255,255,255,0.4); font-size: 13px;">No special achievements granted yet</p>';
      } catch (err) {
        console.error('Failed to load user achievements:', err);
      }
    }

    // Manual achievements list for grant modal
    const manualAchievementsList = [
      { id: 'wings_for_life', name: 'Wings 4 Life', icon: 'ü¶Ö', description: 'Wings 4 Life event participation' },
      { id: 'vip_guest', name: 'VIP Guest', icon: '‚≠ê', description: 'Special guest/influencer status' },
      { id: 'camp_graduate', name: 'Camp Graduate', icon: 'üéì', description: 'Wakeboard camp completion' },
      { id: 'competition_winner', name: 'Competition Winner', icon: 'üèÖ', description: 'Competition victory' }
    ];

    function openGrantAchievementModal(userId, username) {
      const modal = document.getElementById('grantAchievementModal');
      document.getElementById('grantAchievementUserId').value = userId;
      document.getElementById('grantAchievementUsername').textContent = username;
      document.getElementById('grantAchievementNote').value = '';
      
      // Render achievement options with checkboxes
      document.getElementById('achievementOptions').innerHTML = manualAchievementsList.map(a => `
        <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; cursor: pointer; margin-bottom: 8px;">
          <input type="checkbox" name="achievementsToGrant" value="${a.id}" style="width: 18px; height: 18px;">
          <span style="font-size: 28px;">${a.icon}</span>
          <div>
            <div style="font-size: 14px; font-weight: 600; color: #fff;">${a.name}</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.5);">${a.description}</div>
          </div>
        </label>
      `).join('');
      
      modal.classList.add('active');
    }

    async function submitGrantAchievements() {
      const userId = document.getElementById('grantAchievementUserId').value;
      const checkboxes = document.querySelectorAll('input[name="achievementsToGrant"]:checked');
      const note = document.getElementById('grantAchievementNote').value;
      
      if (checkboxes.length === 0) {
        alert('Please select at least one achievement to grant');
        return;
      }
      
      let successCount = 0;
      let errorMessages = [];
      
      for (const checkbox of checkboxes) {
        try {
          await grantAchievement(userId, checkbox.value, note);
          successCount++;
        } catch (err) {
          errorMessages.push(`${checkbox.value}: ${err.message}`);
        }
      }
      
      if (successCount > 0) {
        showToast(`${successCount} achievement(s) granted!`);
        loadUserManualAchievements(userId);
        loadAchievementsStats();
      }
      if (errorMessages.length > 0) {
        alert('Some achievements failed:\n' + errorMessages.join('\n'));
      }
      
      closeModal('grantAchievementModal');
    }

    // ============ INIT ============
    
    document.getElementById('loginPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleLogin();
    });
    document.getElementById('loginEmail').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('loginPassword').focus();
    });
    
    checkAuth();
    
    // Handle deep links (e.g., #users/123)
    function handleDeepLink() {
      const hash = window.location.hash.slice(1);
      if (hash.startsWith('users/')) {
        const userId = hash.split('/')[1];
        if (userId) {
          // Wait for users to load, then highlight the user
          setTimeout(() => {
            // Switch to users tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector('[data-tab="users"]')?.classList.add('active');
            document.getElementById('usersPanel')?.classList.add('active');
            
            // Scroll to and highlight the user row
            const userRow = document.getElementById(`user-row-${userId}`);
            if (userRow) {
              userRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
              userRow.style.background = 'rgba(139,92,246,0.2)';
              userRow.style.transition = 'background 0.3s';
              setTimeout(() => {
                userRow.style.background = '';
              }, 3000);
            }
          }, 1000);
        }
      }
    }
    
    // Run on page load and hash change
    handleDeepLink();
    window.addEventListener('hashchange', handleDeepLink);

    // ============================================================================
    // EMAIL PREVIEW FUNCTIONS
    // ============================================================================
    
    let currentEmailTemplate = null;
    
    const emailTemplateNames = {
      registration_pending: 'Registration Pending',
      account_approved: 'Account Approved',
      purchase_confirmation: 'Purchase Confirmation',
      new_news: 'New News/Announcement',
      achievement_unlocked: 'Achievement Unlocked',
      password_reset: 'Password Reset',
      password_changed: 'Password Changed'
    };

    function showEmailPreview(templateId) {
      currentEmailTemplate = templateId;
      document.getElementById('emailTemplatesGrid').style.display = 'none';
      document.getElementById('emailPreviewSection').style.display = 'block';
      document.getElementById('emailPreviewTitle').textContent = emailTemplateNames[templateId] || templateId;
      
      // Show/hide relevant fields
      document.getElementById('previewProductField').style.display = templateId === 'purchase_confirmation' ? 'block' : 'none';
      document.getElementById('previewPriceField').style.display = templateId === 'purchase_confirmation' ? 'block' : 'none';
      document.getElementById('previewNewsTitleField').style.display = templateId === 'new_news' ? 'block' : 'none';
      document.getElementById('previewNewsMessageField').style.display = templateId === 'new_news' ? 'block' : 'none';
      document.getElementById('previewAchievementField').style.display = templateId === 'achievement_unlocked' ? 'block' : 'none';
      document.getElementById('previewTierField').style.display = templateId === 'achievement_unlocked' ? 'block' : 'none';
      
      updateEmailPreview();
    }

    function hideEmailPreview() {
      document.getElementById('emailTemplatesGrid').style.display = 'grid';
      document.getElementById('emailPreviewSection').style.display = 'none';
      currentEmailTemplate = null;
    }

    function updateEmailPreview() {
      if (!currentEmailTemplate) return;
      
      const d = {
        username: document.getElementById('previewUsername').value || 'User',
        product: document.getElementById('previewProduct').value || 'Product',
        price: document.getElementById('previewPrice').value || '0',
        orderId: 'ORD-' + Math.random().toString(36).substr(2, 6).toUpperCase(),
        newsTitle: document.getElementById('previewNewsTitle').value || 'News',
        newsMessage: document.getElementById('previewNewsMessage').value || 'Message',
        achievementName: document.getElementById('previewAchievement').value || 'Achievement',
        achievementIcon: 'üèÜ',
        achievementTier: document.getElementById('previewTier').value || 'Gold'
      };
      
      const html = generateEmailHTML(currentEmailTemplate, d);
      document.getElementById('emailPreviewContent').innerHTML = html;
    }

    function generateEmailHTML(templateId, d) {
      const styles = `
        <style>
          .email-preview-wrap { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a15; padding: 20px; }
          .email-container { max-width: 420px; margin: 0 auto; background: linear-gradient(180deg, rgba(139,92,246,0.08) 0%, rgba(10,10,21,1) 100%); border: 1px solid rgba(139,92,246,0.2); border-radius: 20px; overflow: hidden; }
          .email-header { background: linear-gradient(135deg, #8b5cf6, #7c3aed); padding: 28px 24px; text-align: center; }
          .email-logo { width: 56px; height: 56px; border-radius: 14px; margin-bottom: 12px; }
          .email-brand { font-size: 18px; font-weight: 700; color: #fff; margin: 0; letter-spacing: 0.5px; }
          .email-body { padding: 28px 24px; }
          .email-emoji { font-size: 48px; text-align: center; margin-bottom: 16px; }
          .email-title { font-size: 22px; font-weight: 700; color: #fff; text-align: center; margin: 0 0 16px 0; }
          .email-text { font-size: 15px; color: rgba(255,255,255,0.7); line-height: 1.6; margin: 0 0 16px 0; text-align: center; }
          .email-highlight { color: #a78bfa; font-weight: 600; }
          .email-button { display: block; width: 100%; padding: 16px 24px; background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: #fff !important; text-decoration: none; text-align: center; border-radius: 12px; font-weight: 600; font-size: 15px; margin: 24px 0; box-sizing: border-box; }
          .email-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin: 16px 0; }
          .email-card-success { background: rgba(34,197,94,0.1); border-color: rgba(34,197,94,0.2); }
          .email-card-warning { background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.2); }
          .email-card-info { background: rgba(139,92,246,0.1); border-color: rgba(139,92,246,0.2); }
          .email-footer { padding: 20px 24px; background: rgba(0,0,0,0.3); text-align: center; border-top: 1px solid rgba(255,255,255,0.05); }
          .email-footer-text { font-size: 12px; color: rgba(255,255,255,0.4); margin: 0 0 4px 0; }
          .email-footer-link { color: #a78bfa; text-decoration: none; }
          .email-order-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
          .email-order-row:last-child { border-bottom: none; padding-top: 12px; margin-top: 4px; border-top: 1px solid rgba(255,255,255,0.1); }
          .email-order-label { color: rgba(255,255,255,0.5); font-size: 14px; }
          .email-order-value { color: #fff; font-size: 14px; font-weight: 500; }
          .email-order-total { color: #22c55e; font-size: 20px; font-weight: 700; }
          .email-tier-badge { display: inline-block; padding: 6px 16px; background: rgba(234,179,8,0.2); border-radius: 20px; font-size: 12px; font-weight: 700; color: #eab308; text-transform: uppercase; margin-top: 8px; }
        </style>
      `;

      const header = `
        <div class="email-header">
          <img src="https://flatwater.space/img/lunar-logo.png" alt="Lunar" class="email-logo" onerror="this.style.display='none'" />
          <p class="email-brand">FLATWATER by LUNAR</p>
        </div>
      `;

      const footer = `
        <div class="email-footer">
          <p class="email-footer-text">¬© 2026 Flatwater by Lunar. All rights reserved.</p>
          <p class="email-footer-text"><a href="https://flatwater.space" class="email-footer-link">flatwater.space</a></p>
        </div>
      `;

      const templates = {
        registration_pending: `
          <div class="email-body">
            <div class="email-emoji">‚è≥</div>
            <h1 class="email-title">Welcome, ${d.username}!</h1>
            <p class="email-text">Thank you for registering at <span class="email-highlight">Flatwater by Lunar</span>!</p>
            <p class="email-text">Your account is now <span class="email-highlight">pending approval</span>. You'll receive another email once your account is activated.</p>
            <div class="email-card email-card-info">
              <p class="email-text" style="margin:0;font-size:14px;">‚è±Ô∏è Approval usually takes less than 24 hours</p>
            </div>
            <p class="email-text" style="margin-top:24px;">See you on the water soon! üåä</p>
          </div>
        `,
        account_approved: `
          <div class="email-body">
            <div class="email-emoji">üéâ</div>
            <h1 class="email-title">You're In, ${d.username}!</h1>
            <p class="email-text">Great news! Your account has been approved. You can now log in and start tracking your wakeboarding progression!</p>
            <a href="https://flatwater.space" class="email-button">Let's Ride! üèÑ</a>
            <div class="email-card email-card-success">
              <p class="email-text" style="margin:0;font-size:14px;text-align:left;">
                üèãÔ∏è Track your tricks in <strong>Train</strong><br/>
                üìö Learn from articles in <strong>Learn</strong><br/>
                üìÖ Join sessions in <strong>Calendar</strong><br/>
                üë• Connect with the <strong>Crew</strong>
              </p>
            </div>
          </div>
        `,
        purchase_confirmation: `
          <div class="email-body">
            <div class="email-emoji">üõí</div>
            <h1 class="email-title">Thanks for your order!</h1>
            <p class="email-text">Hi ${d.username}, your purchase has been confirmed.</p>
            <div class="email-card">
              <div class="email-order-row">
                <span class="email-order-label">Order ID</span>
                <span class="email-order-value" style="font-family:monospace;">${d.orderId}</span>
              </div>
              <div class="email-order-row">
                <span class="email-order-label">Product</span>
                <span class="email-order-value">${d.product}</span>
              </div>
              <div class="email-order-row">
                <span class="email-order-label">Total</span>
                <span class="email-order-total">${d.price} ‚Ç¨</span>
              </div>
            </div>
            <p class="email-text" style="font-size:13px;color:rgba(255,255,255,0.5);">Thank you for your purchase! If you have any questions, please contact us.</p>
          </div>
        `,
        new_news: `
          <div class="email-body">
            <div class="email-emoji">üì¢</div>
            <h1 class="email-title">Hey ${d.username}!</h1>
            <p class="email-text">We have news for you:</p>
            <div class="email-card" style="background:rgba(59,130,246,0.1);border-color:rgba(59,130,246,0.2);">
              <h3 style="color:#fff;font-size:18px;margin:0 0 8px 0;text-align:center;">${d.newsTitle}</h3>
              <p class="email-text" style="margin:0;text-align:left;">${d.newsMessage}</p>
            </div>
            <a href="https://flatwater.space" class="email-button" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);">Read More</a>
          </div>
        `,
        achievement_unlocked: `
          <div class="email-body">
            <div class="email-emoji">${d.achievementIcon}</div>
            <h1 class="email-title">Achievement Unlocked!</h1>
            <p class="email-text">Congratulations ${d.username}! You've earned a new achievement:</p>
            <div class="email-card" style="text-align:center;background:rgba(234,179,8,0.1);border-color:rgba(234,179,8,0.2);">
              <div style="font-size:48px;margin-bottom:8px;">${d.achievementIcon}</div>
              <h3 style="color:#fff;font-size:20px;margin:0;">${d.achievementName}</h3>
              <span class="email-tier-badge">${d.achievementTier} Tier</span>
            </div>
            <a href="https://flatwater.space" class="email-button" style="background:linear-gradient(135deg,#eab308,#fbbf24);">View All Achievements</a>
            <p class="email-text">Keep up the great work! üí™</p>
          </div>
        `,
        password_reset: `
          <div class="email-body">
            <div class="email-emoji">üîê</div>
            <h1 class="email-title">Password Reset</h1>
            <p class="email-text">Hi ${d.username}, we received a request to reset your password.</p>
            <p class="email-text">Click the button below to create a new password:</p>
            <a href="#" class="email-button" style="background:linear-gradient(135deg,#ef4444,#f87171);">Reset Password</a>
            <div class="email-card email-card-warning">
              <p class="email-text" style="margin:0;font-size:13px;">
                ‚ö†Ô∏è This link expires in <strong style="color:#ef4444;">1 hour</strong>.<br/><br/>
                If you didn't request this, you can safely ignore this email.
              </p>
            </div>
          </div>
        `,
        password_changed: `
          <div class="email-body">
            <div class="email-emoji">üîí</div>
            <h1 class="email-title">Password Updated</h1>
            <p class="email-text">Hi ${d.username}, your password has been successfully changed.</p>
            <div class="email-card email-card-success">
              <p class="email-text" style="margin:0;font-size:14px;">‚úÖ Your account is now secured with your new password.</p>
            </div>
            <a href="https://flatwater.space" class="email-button">Log In Now</a>
            <p class="email-text" style="font-size:13px;color:rgba(255,255,255,0.5);">If you didn't make this change, please contact us immediately.</p>
          </div>
        `
      };

      return `
        <div class="email-preview-wrap">
          ${styles}
          <div class="email-container">
            ${header}
            ${templates[templateId] || '<div class="email-body"><p class="email-text">Template not found</p></div>'}
            ${footer}
          </div>
        </div>
      `;
    }
  </script>
</body>
</html>